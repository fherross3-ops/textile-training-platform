<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Capacitación Textil</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --text-color: #333;
            --border-radius: 6px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--secondary-color);
            margin-bottom: 30px;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: #f9f9f9;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            display: block;
            width: 100%;
            margin-top: 20px;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: var(--primary-color);
        }
        
        .btn-secondary:hover {
            background-color: #1a252f;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #25a25a;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .required::after {
            content: " *";
            color: var(--accent-color);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .alert {
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .process-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .process-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .process-item:hover {
            background-color: #e3f2fd;
        }
        
        .process-item.selected {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .radio-option input[type="radio"] {
            width: auto;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .action-buttons button {
            flex: 1;
            min-width: 150px;
        }
        
        .repository-section {
            margin-top: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: #f9f9f9;
        }
        
        .kpi-list {
            margin-top: 20px;
        }
        
        .kpi-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            background-color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .kpi-info {
            flex: 1;
        }
        
        .kpi-actions {
            display: flex;
            gap: 10px;
        }
        
        .kpi-actions button {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .hidden {
            display: none;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Estilos para la sección de recursos */
        .resources-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 1rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .back-btn {
            display: inline-block;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        
        .content-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        footer {
            text-align: center;
            margin-top: 2rem;
            padding: 1rem;
            background: #2c3e50;
            color: white;
        }
        
        /* Estilos para impresión */
        @media print {
            body {
                background-color: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                padding: 15px;
                max-width: 100%;
            }
            
            .action-buttons, 
            .tabs,
            .repository-section,
            .btn-primary,
            .process-selector {
                display: none !important;
            }
            
            .form-section {
                border: 1px solid #ddd;
                background-color: white;
                page-break-inside: avoid;
                margin-bottom: 20px;
            }
            
            h1 {
                font-size: 24px;
                text-align: center;
                border-bottom: 2px solid #3498db;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
            
            h2 {
                font-size: 18px;
                color: #2c3e50;
                border-bottom: 1px solid #ddd;
                padding-bottom: 8px;
                margin-bottom: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            input, select, textarea {
                border: 1px solid #ddd;
                background-color: #f9f9f9;
                padding: 8px;
            }
            
            .radio-group {
                margin-bottom: 10px;
            }
            
            /* Mostrar valores seleccionados como texto normal */
            .process-item.selected {
                background-color: transparent;
                color: #333;
                border: 1px solid #ddd;
                font-weight: bold;
            }
            
            /* Ocultar todos los procesos no seleccionados */
            .process-item:not(.selected) {
                display: none;
            }
            
            /* Mostrar solo el proceso seleccionado */
            .process-selector {
                display: block;
                margin-bottom: 15px;
            }
            
            /* Estilo para valores de radio seleccionados */
            .radio-option input[type="radio"]:not(:checked) + label {
                display: none;
            }
            
            .radio-option input[type="radio"]:checked + label {
                display: block;
                font-weight: bold;
                margin-bottom: 10px;
            }
            
            .radio-option input[type="radio"] {
                display: none;
            }
            
            .radio-group {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .process-selector {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .kpi-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .kpi-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
    <!-- Librería para exportación a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Plataforma de Capacitación Textil</h1>
        
        <div class="tabs">
            <div class="tab active" data-tab="kpi">Diseño de KPI</div>
            <div class="tab" data-tab="resources">Recursos</div>
        </div>
        
        <div id="alertBox" class="alert"></div>
        
        <!-- Pestaña de KPI -->
        <div id="kpiTab" class="tab-content active">
            <!-- Formulario para Netlify (oculto) -->
            <form name="kpi-netlify-form" netlify netlify-honeypot="bot-field" hidden>
                <input type="text" name="kpiName">
                <input type="text" name="kpiDescription">
                <input type="text" name="kpiObjective">
                <input type="text" name="selectedProcess">
                <input type="text" name="variables">
                <input type="text" name="measurementUnit">
                <input type="text" name="formula">
                <input type="text" name="frequency">
                <input type="text" name="targetValue">
                <input type="text" name="minValue">
                <input type="text" name="maxValue">
                <input type="text" name="toleranceRange">
                <input type="text" name="sisgoGrafico">
                <input type="text" name="utilidadComentario">
                <input type="text" name="designResponsible">
                <input type="text" name="implementationResponsible">
                <input type="text" name="monitoringResponsible">
                <input type="text" name="emailContact">
            </form>
            
            <!-- Formulario principal (interfaz de usuario) -->
            <form id="kpiForm">
                <!-- Sección 1: Información básica del KPI -->
                <div class="form-section">
                    <h2>Información Básica del KPI</h2>
                    
                    <div class="form-group">
                        <label for="kpiName" class="required">Nombre del KPI</label>
                        <input type="text" id="kpiName" name="kpiName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="kpiDescription" class="required">Descripción del KPI</label>
                        <textarea id="kpiDescription" name="kpiDescription" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="kpiObjective" class="required">Objetivo del KPI</label>
                        <textarea id="kpiObjective" name="kpiObjective" required></textarea>
                    </div>
                </div>
                
                <!-- Sección 2: Selección de proceso -->
                <div class="form-section">
                    <h2>Selección de Proceso Textil</h2>
                    <p>Seleccione el proceso al que aplicará este KPI:</p>
                    
                    <div class="process-selector">
                        <div class="process-item" data-process="apertura_algodon">Apertura Algodón</div>
                        <div class="process-item" data-process="cardas">Cardas</div>
                        <div class="process-item" data-process="manuares">Manuares</div>
                        <div class="process-item" data-process="mecheras">Mecheras</div>
                        <div class="process-item" data-process="hilatura_anillos">Hilatura Anillos</div>
                        <div class="process-item" data-process="hilatura_openend">Hilatura Open-End</div>
                        <div class="process-item" data-process="urdido">Urdido</div>
                        <div class="process-item" data-process="tenido">Teñido</div>
                        <div class="process-item" data-process="reurdido">Reurdido</div>
                        <div class="process-item" data-process="engomado">Engomado</div>
                        <div class="process-item" data-process="tejeduria">Tejeduría</div>
                        <div class="process-item" data-process="acabado">Acabado</div>
                        <div class="process-item" data-process="revision">Revisión</div>
                        <div class="process-item" data-process="despacho">Despacho</div>
                        <div class="process-item" data-process="servicios">Servicios</div>
                        <div class="process-item" data-process="logistica">Logística</div>
                        <div class="process-item" data-process="calidad">Calidad</div>
                    </div>
                    
                    <input type="hidden" id="selectedProcess" name="selectedProcess" required>
                </div>
                
                <!-- Sección 3: Parámetros y Fórmulas -->
                <div class="form-section">
                    <h2>Parámetros y Fórmulas</h2>
                    
                    <div class="form-group">
                        <label for="variables" class="required">Variables a Medir (separadas por coma)</label>
                        <input type="text" id="variables" name="variables" placeholder="Ej: Tiempo ciclo, Defectos, Producción" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="measurementUnit" class="required">Unidad de Medida</label>
                        <input type="text" id="measurementUnit" name="measurementUnit" placeholder="Ej: Unidades por hora, Porcentaje, Partes por millón" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="formula" class="required">Fórmula de Cálculo</label>
                        <textarea id="formula" name="formula" placeholder="Ej: (Producción real / Producción planeada) * 100" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="frequency" class="required">Frecuencia de Medición</label>
                        <select id="frequency" name="frequency" required>
                            <option value="">Seleccione una frecuencia</option>
                            <option value="continua">Continua</option>
                            <option value="horaria">Horaria</option>
                            <option value="diaria">Diaria</option>
                            <option value="semanal">Semanal</option>
                            <option value="mensual">Mensual</option>
                        </select>
                    </div>
                </div>
                
                <!-- Sección 4: Metas y Valores Esperados -->
                <div class="form-section">
                    <h2>Metas y Valores Esperados</h2>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="targetValue" class="required">Valor Meta</label>
                                <input type="number" id="targetValue" name="targetValue" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="form-col">
                            <div class="form-group">
                                <label for="minValue" class="required">Valor Mínimo Aceptable</label>
                                <input type="number" id="minValue" name="minValue" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="form-col">
                            <div class="form-group">
                                <label for="maxValue">Valor Máximo Esperado</label>
                                <input type="number" id="maxValue" name="maxValue" step="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="toleranceRange">Rango de Tolerancia (±)</label>
                        <input type="number" id="toleranceRange" name="toleranceRange" step="0.01" placeholder="Porcentaje o valor absoluto">
                    </div>
                </div>
                
                <!-- Nueva Sección: Gráfico en SISGO y Utilidad -->
                <div class="form-section">
                    <h2>Información Adicional del KPI</h2>
                    
                    <div class="form-group">
                        <label class="required">¿El Indicador Clave de Desempeño (KPI) diseñado tiene Gráfico en SISGO?</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="sisgoSi" name="sisgoGrafico" value="si" required>
                                <label for="sisgoSi">Sí</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="sisgoNo" name="sisgoGrafico" value="no">
                                <label for="sisgoNo">No</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="utilidadComentario">Comentario sobre utilidad:</label>
                        <textarea id="utilidadComentario" name="utilidadComentario" placeholder="Actualmente es utilizado por Usted y le es Útil o requiere ser mejorado?"></textarea>
                    </div>
                </div>
                
                <!-- Sección 5: Responsables -->
                <div class="form-section">
                    <h2>Responsables</h2>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="designResponsible" class="required">Responsable del Diseño</label>
                                <input type="text" id="designResponsible" name="designResponsible" required>
                            </div>
                        </div>
                        
                        <div class="form-col">
                            <div class="form-group">
                                <label for="implementationResponsible" class="required">Responsable de Implementación</label>
                                <input type="text" id="implementationResponsible" name="implementationResponsible" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="monitoringResponsible" class="required">Responsable de Monitoreo</label>
                                <input type="text" id="monitoringResponsible" name="monitoringResponsible" required>
                            </div>
                        </div>
                        
                        <div class="form-col">
                            <div class="form-group">
                                <label for="emailContact">Correo de Contacto</label>
                                <input type="email" id="emailContact" name="emailContact" placeholder="ejemplo@empresa.com">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="btn-primary">Guardar KPI</button>
                    <button type="button" id="btnExportPDF" class="btn-secondary">Exportar a PDF</button>
                    <button type="button" id="btnExportWord" class="btn-success">Exportar a Word</button>
                    <button type="button" id="btnPrint" class="btn-warning">Imprimir Formulario</button>
                    <button type="button" id="btnImportCSV" class="btn-warning">Importar desde CSV</button>
                    <button type="button" id="btnExportCSV" class="btn-secondary">Exportar a CSV</button>
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                </div>
            </form>
        </div>
        
        <!-- Pestaña de recursos -->
        <div id="resourcesTab" class="tab-content">
            <div class="resources-header">
                <h2>Recursos</h2>
                <p>Material complementario para la capacitación textil</p>
            </div>
            
            <div class="container">
                <a href="#" class="back-btn" id="backToKPI">← Volver al inicio</a>
                
                <div class="content-section">
                    <h2>Manuales Técnicos</h2>
                    <p>En esta sección encontrarás manuales técnicos de todos los procesos textiles.</p>
                    <ul>
                        <li><a href="manual_hilanderia.pdf">Manual de Hilandería</a></li>
                        <li><a href="manual_procesos_humedos.pdf">Manual de Procesos Húmedos</a></li>
                        <li><a href="manual_tejeduria.pdf">Manual de Tejeduría</a></li>
                        <!-- Agrega más manuales -->
                    </ul>
                </div>
                
                <div class="content-section">
                    <h2>Procedimientos Operativos</h2>
                    <p>Procedimientos estandarizados para cada operación.</p>
                    <ul>
                        <li><a href="procedimiento_operativo_hilanderia.pdf">Procedimiento de Hilandería</a></li>
                        <li><a href="procedimiento_operativo_tejeduria.pdf">Procedimiento de Tejeduría</a></li>
                        <!-- Agrega más procedimientos -->
                    </ul>
                </div>
                
                <div class="content-section">
                    <h2>Normativas de Calidad</h2>
                    <p>Normas y estándares de calidad aplicables.</p>
                    <ul>
                        <li><a href="norma_calidad_textil.pdf">Norma de Calidad Textil</a></li>
                        <li><a href="especificaciones_tecnicas.pdf">Especificaciones Técnicas</a></li>
                        <!-- Agrega más normativas -->
                    </ul>
                </div>
                
                <div class="content-section">
                    <h2>Formatos y Plantillas</h2>
                    <p>Formatos para registro de datos y control de procesos.</p>
                    <ul>
                        <li><a href="formato_control_calidad.xlsx">Formato de Control de Calidad</a></li>
                        <li><a href="formato_produccion_diaria.xlsx">Formato de Producción Diaria</a></li>
                        <!-- Agrega más formatos -->
                    </ul>
                </div>
            </div>
            
            <footer>
                <p>Plataforma de Capacitación Textil &copy; 2024</p>
            </footer>
        </div>
    </div>

    <script>
        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Variables globales
            let kpiRepository = JSON.parse(localStorage.getItem('kpiRepository')) || [];
            const currentKPIId = new URLSearchParams(window.location.search).get('id');
            
            // Elementos del DOM
            const processItems = document.querySelectorAll('.process-item');
            const selectedProcessInput = document.getElementById('selectedProcess');
            const form = document.getElementById('kpiForm');
            const alertBox = document.getElementById('alertBox');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const backToKPIBtn = document.getElementById('backToKPI');
            
            // Inicializar la aplicación
            initApp();
            
            function initApp() {
                // Configurar selección de procesos
                setupProcessSelection();
                
                // Configurar eventos del formulario
                setupFormEvents();
                
                // Configurar pestañas
                setupTabs();
                
                // Configurar botones de acción
                setupActionButtons();
                
                // Configurar botón de volver
                if (backToKPIBtn) {
                    backToKPIBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        // Activar la pestaña de KPI
                        document.querySelector('.tab[data-tab="kpi"]').click();
                    });
                }
                
                // Cargar KPI si hay un ID en la URL (modo edición)
                if (currentKPIId) {
                    loadKPIForEditing(currentKPIId);
                }
            }
            
            function setupProcessSelection() {
                processItems.forEach(item => {
                    item.addEventListener('click', function() {
                        // Remover selección previa
                        processItems.forEach(pi => pi.classList.remove('selected'));
                        
                        // Marcar como seleccionado
                        this.classList.add('selected');
                        selectedProcessInput.value = this.getAttribute('data-process');
                    });
                });
            }
            
            function setupFormEvents() {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveKPI();
                });
            }
            
            function setupTabs() {
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        const tabId = this.getAttribute('data-tab');
                        
                        // Activar pestaña seleccionada
                        tabs.forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Mostrar contenido correspondiente
                        tabContents.forEach(content => content.classList.remove('active'));
                        document.getElementById(`${tabId}Tab`).classList.add('active');
                    });
                });
            }
            
            function setupActionButtons() {
                // Botón para exportar a PDF
                document.getElementById('btnExportPDF').addEventListener('click', exportToPDF);
                
                // Botón para exportar a Word
                document.getElementById('btnExportWord').addEventListener('click', exportToWord);
                
                // Botón para imprimir
                document.getElementById('btnPrint').addEventListener('click', printForm);
                
                // Botón para importar desde CSV
                document.getElementById('btnImportCSV').addEventListener('click', function() {
                    document.getElementById('csvFileInput').click();
                });
                
                // Botón para exportar a CSV
                document.getElementById('btnExportCSV').addEventListener('click', exportToCSV);
                
                // Cargar archivo CSV
                document.getElementById('csvFileInput').addEventListener('change', handleCSVImport);
            }
            
            function saveKPI() {
                // Validar que se haya seleccionado un proceso
                if (!selectedProcessInput.value) {
                    showAlert('Por favor, seleccione un proceso textil.', 'error');
                    return;
                }
                
                // Validar que el valor mínimo sea menor que el valor meta
                const minValue = parseFloat(document.getElementById('minValue').value);
                const targetValue = parseFloat(document.getElementById('targetValue').value);
                
                if (minValue >= targetValue) {
                    showAlert('El valor mínimo debe ser inferior al valor meta.', 'error');
                    return;
                }
                
                // Validar que se haya seleccionado una opción para el gráfico SISGO
                const sisgoGrafico = document.querySelector('input[name="sisgoGrafico"]:checked');
                if (!sisgoGrafico) {
                    showAlert('Por favor, seleccione si el KPI tiene gráfico en SISGO.', 'error');
                    return;
                }
                
                // Recopilar datos del formulario
                const formData = new FormData(form);
                const formObject = Object.fromEntries(formData.entries());
                
                // Añadir ID y timestamp
                const kpiData = {
                    id: currentKPIId || Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    ...formObject
                };
                
                // Guardar en el repositorio
                if (currentKPIId) {
                    // Modo edición: reemplazar KPI existente
                    const index = kpiRepository.findIndex(kpi => kpi.id === currentKPIId);
                    if (index !== -1) {
                        kpiRepository[index] = kpiData;
                    }
                } else {
                    // Modo nuevo: añadir al repositorio
                    kpiRepository.push(kpiData);
                }
                
                // Guardar en localStorage
                localStorage.setItem('kpiRepository', JSON.stringify(kpiRepository));
                
                // Enviar a Netlify Forms
                submitToNetlify(kpiData);
                
                // Mostrar mensaje de éxito
                showAlert('KPI guardado exitosamente. Será revisado por el equipo de calidad.', 'success');
                
                // Limpiar formulario después de 2 segundos
                setTimeout(() => {
                    if (!currentKPIId) {
                        form.reset();
                        processItems.forEach(pi => pi.classList.remove('selected'));
                    }
                    alertBox.style.display = 'none';
                    
                    // Si estábamos editando, redirigir al listado
                    if (currentKPIId) {
                        window.location.href = window.location.pathname;
                    }
                }, 2000);
            }
            
            function submitToNetlify(kpiData) {
                // Crear formulario oculto para Netlify
                const netlifyForm = document.querySelector('form[name="kpi-netlify-form"]');
                
                // Llenar los campos del formulario Netlify
                netlifyForm.querySelector('input[name="kpiName"]').value = kpiData.kpiName || '';
                netlifyForm.querySelector('input[name="kpiDescription"]').value = kpiData.kpiDescription || '';
                netlifyForm.querySelector('input[name="kpiObjective"]').value = kpiData.kpiObjective || '';
                netlifyForm.querySelector('input[name="selectedProcess"]').value = kpiData.selectedProcess || '';
                netlifyForm.querySelector('input[name="variables"]').value = kpiData.variables || '';
                netlifyForm.querySelector('input[name="measurementUnit"]').value = kpiData.measurementUnit || '';
                netlifyForm.querySelector('input[name="formula"]').value = kpiData.formula || '';
                netlifyForm.querySelector('input[name="frequency"]').value = kpiData.frequency || '';
                netlifyForm.querySelector('input[name="targetValue"]').value = kpiData.targetValue || '';
                netlifyForm.querySelector('input[name="minValue"]').value = kpiData.minValue || '';
                netlifyForm.querySelector('input[name="maxValue"]').value = kpiData.maxValue || '';
                netlifyForm.querySelector('input[name="toleranceRange"]').value = kpiData.toleranceRange || '';
                netlifyForm.querySelector('input[name="sisgoGrafico"]').value = kpiData.sisgoGrafico || '';
                netlifyForm.querySelector('input[name="utilidadComentario"]').value = kpiData.utilidadComentario || '';
                netlifyForm.querySelector('input[name="designResponsible"]').value = kpiData.designResponsible || '';
                netlifyForm.querySelector('input[name="implementationResponsible"]').value = kpiData.implementationResponsible || '';
                netlifyForm.querySelector('input[name="monitoringResponsible"]').value = kpiData.monitoringResponsible || '';
                netlifyForm.querySelector('input[name="emailContact"]').value = kpiData.emailContact || '';
                
                // Crear un formulario temporal para enviar
                const tempForm = document.createElement('form');
                tempForm.method = 'POST';
                tempForm.action = '/';
                tempForm.style.display = 'none';
                
                // Agregar todos los campos al formulario temporal
                const fields = netlifyForm.querySelectorAll('input, textarea, select');
                fields.forEach(field => {
                    const clone = field.cloneNode(true);
                    tempForm.appendChild(clone);
                });
                
                // Agregar el formulario temporal al documento y enviarlo
                document.body.appendChild(tempForm);
                tempForm.submit();
                document.body.removeChild(tempForm);
            }
            
            function loadKPIForEditing(id) {
                const kpi = kpiRepository.find(item => item.id === id);
                if (kpi) {
                    // Llenar el formulario con los datos del KPI
                    document.getElementById('kpiName').value = kpi.kpiName || '';
                    document.getElementById('kpiDescription').value = kpi.kpiDescription || '';
                    document.getElementById('kpiObjective').value = kpi.kpiObjective || '';
                    
                    // Seleccionar proceso
                    if (kpi.selectedProcess) {
                        const processItem = document.querySelector(`.process-item[data-process="${kpi.selectedProcess}"]`);
                        if (processItem) {
                            processItem.classList.add('selected');
                            selectedProcessInput.value = kpi.selectedProcess;
                        }
                    }
                    
                    document.getElementById('variables').value = kpi.variables || '';
                    document.getElementById('measurementUnit').value = kpi.measurementUnit || '';
                    document.getElementById('formula').value = kpi.formula || '';
                    document.getElementById('frequency').value = kpi.frequency || '';
                    document.getElementById('targetValue').value = kpi.targetValue || '';
                    document.getElementById('minValue').value = kpi.minValue || '';
                    document.getElementById('maxValue').value = kpi.maxValue || '';
                    document.getElementById('toleranceRange').value = kpi.toleranceRange || '';
                    
                    // Seleccionar opción de SISGO
                    if (kpi.sisgoGrafico) {
                        document.querySelector(`input[name="sisgoGrafico"][value="${kpi.sisgoGrafico}"]`).checked = true;
                    }
                    
                    document.getElementById('utilidadComentario').value = kpi.utilidadComentario || '';
                    document.getElementById('designResponsible').value = kpi.designResponsible || '';
                    document.getElementById('implementationResponsible').value = kpi.implementationResponsible || '';
                    document.getElementById('monitoringResponsible').value = kpi.monitoringResponsible || '';
                    document.getElementById('emailContact').value = kpi.emailContact || '';
                    
                    // Cambiar texto del botón
                    document.querySelector('.btn-primary').textContent = 'Actualizar KPI';
                }
            }
            
            function showAlert(message, type) {
                alertBox.textContent = message;
                alertBox.className = `alert alert-${type}`;
                alertBox.style.display = 'block';
                
                // Desplazar hacia la alerta
                alertBox.scrollIntoView({ behavior: 'smooth' });
            }
            
            function exportToPDF() {
                const doc = new jsPDF();
                
                // Título
                doc.setFontSize(20);
                doc.text('Diseño de KPI Textil', 105, 15, { align: 'center' });
                
                // Información básica
                doc.setFontSize(16);
                doc.text('Información Básica del KPI', 14, 25);
                
                doc.setFontSize(12);
                doc.text(`Nombre: ${document.getElementById('kpiName').value}`, 14, 35);
                doc.text(`Descripción: ${document.getElementById('kpiDescription').value}`, 14, 45);
                
                // Ajustar texto largo
                const descriptionLines = doc.splitTextToSize(document.getElementById('kpiDescription').value, 180);
                doc.text(descriptionLines, 14, 45);
                
                let yPosition = 45 + (descriptionLines.length * 6);
                
                doc.text(`Objetivo: ${document.getElementById('kpiObjective').value}`, 14, yPosition);
                const objectiveLines = doc.splitTextToSize(document.getElementById('kpiObjective').value, 180);
                doc.text(objectiveLines, 14, yPosition);
                
                yPosition += (objectiveLines.length * 6) + 10;
                
                // Proceso seleccionado
                doc.text(`Proceso: ${selectedProcessInput.value}`, 14, yPosition);
                yPosition += 10;
                
                // Parámetros y fórmulas
                doc.setFontSize(16);
                doc.text('Parámetros y Fórmulas', 14, yPosition);
                yPosition += 10;
                
                doc.setFontSize(12);
                doc.text(`Variables: ${document.getElementById('variables').value}`, 14, yPosition);
                yPosition += 10;
                doc.text(`Unidad de Medida: ${document.getElementById('measurementUnit').value}`, 14, yPosition);
                yPosition += 10;
                doc.text(`Fórmula: ${document.getElementById('formula').value}`, 14, yPosition);
                yPosition += 10;
                doc.text(`Frecuencia: ${document.getElementById('frequency').value}`, 14, yPosition);
                yPosition += 15;
                
                // Metas y valores
                doc.setFontSize(16);
                doc.text('Metas y Valores Esperados', 14, yPosition);
                yPosition += 10;
                
                doc.setFontSize(12);
                doc.text(`Valor Meta: ${document.getElementById('targetValue').value}`, 14, yPosition);
                yPosition += 10;
                doc.text(`Valor Mínimo: ${document.getElementById('minValue').value}`, 14, yPosition);
                yPosition += 10;
                doc.text(`Valor Máximo: ${document.getElementById('maxValue').value}`, 14, yPosition);
                yPosition += 10;
                doc.text(`Rango de Tolerancia: ${document.getElementById('toleranceRange').value}`, 14, yPosition);
                yPosition += 15;
                
                // Responsables
                doc.setFontSize(16);
                doc.text('Responsables', 14, yPosition);
                yPosition += 10;
                
                doc.setFontSize(12);
                doc.text(`Diseño: ${document.getElementById('designResponsible').value}`, 14, yPosition);
                yPosition += 10;
                doc.text(`Implementación: ${document.getElementById('implementationResponsible').value}`, 14, yPosition);
                yPosition += 10;
                doc.text(`Monitoreo: ${document.getElementById('monitoringResponsible').value}`, 14, yPosition);
                yPosition += 10;
                doc.text(`Contacto: ${document.getElementById('emailContact').value}`, 14, yPosition);
                
                // Guardar PDF
                doc.save('KPI_Textil.pdf');
            }
            
            function exportToWord() {
                // Crear contenido HTML para el documento Word
                const content = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset='utf-8'>
                        <title>Diseño de KPI Textil</title>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            h1 { color: #2c3e50; }
                            h2 { color: #3498db; border-bottom: 1px solid #3498db; padding-bottom: 5px; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                        </style>
                    </head>
                    <body>
                        <h1>Diseño de KPI Textil</h1>
                        
                        <h2>Información Básica del KPI</h2>
                        <table>
                            <tr><th>Nombre del KPI</th><td>${document.getElementById('kpiName').value}</td></tr>
                            <tr><th>Descripción</th><td>${document.getElementById('kpiDescription').value}</td></tr>
                            <tr><th>Objetivo</th><td>${document.getElementById('kpiObjective').value}</td></tr>
                            <tr><th>Proceso</th><td>${selectedProcessInput.value}</td></tr>
                        </table>
                        
                        <h2>Parámetros y Fórmulas</h2>
                        <table>
                            <tr><th>Variables a Medir</th><td>${document.getElementById('variables').value}</td></tr>
                            <tr><th>Unidad de Medida</th><td>${document.getElementById('measurementUnit').value}</td></tr>
                            <tr><th>Fórmula de Cálculo</th><td>${document.getElementById('formula').value}</td></tr>
                            <tr><th>Frecuencia de Medición</th><td>${document.getElementById('frequency').value}</td></tr>
                        </table>
                        
                        <h2>Metas y Valores Esperados</h2>
                        <table>
                            <tr><th>Valor Meta</th><td>${document.getElementById('targetValue').value}</td></tr>
                            <tr><th>Valor Mínimo Aceptable</th><td>${document.getElementById('minValue').value}</td></tr>
                            <tr><th>Valor Máximo Esperado</th><td>${document.getElementById('maxValue').value}</td></tr>
                            <tr><th>Rango de Tolerancia</th><td>${document.getElementById('toleranceRange').value}</td></tr>
                        </table>
                        
                        <h2>Responsables</h2>
                        <table>
                            <tr><th>Responsable del Diseño</th><td>${document.getElementById('designResponsible').value}</td></tr>
                            <tr><th>Responsable de Implementación</th><td>${document.getElementById('implementationResponsible').value}</td></tr>
                            <tr><th>Responsable de Monitoreo</th><td>${document.getElementById('monitoringResponsible').value}</td></tr>
                            <tr><th>Correo de Contacto</th><td>${document.getElementById('emailContact').value}</td></tr>
                        </table>
                    </body>
                    </html>
                `;
                
                // Crear blob y descargar
                const blob = new Blob([content], { type: 'application/msword' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'KPI_Textil.doc';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function printForm() {
                window.print();
            }
            
            function exportToCSV() {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // Crear contenido CSV
                let csvContent = 'Clave,Valor\n';
                for (const [key, value] of Object.entries(data)) {
                    csvContent += `"${key}","${value}"\n`;
                }
                
                // Añadir proceso seleccionado
                csvContent += `"selectedProcess","${selectedProcessInput.value}"\n`;
                
                // Crear blob y descargar
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'KPI_Textil.csv';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function handleCSVImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n');
                    
                    // Procesar cada línea del CSV
                    const data = {};
                    for (let i = 1; i < lines.length; i++) { // Saltar la cabecera
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const [key, value] = line.split(',').map(item => 
                            item.replace(/^"|"$/g, '').trim() // Eliminar comillas
                        );
                        
                        if (key && value) {
                            data[key] = value;
                        }
                    }
                    
                    // Llenar el formulario con los datos importados
                    if (data.kpiName) document.getElementById('kpiName').value = data.kpiName;
                    if (data.kpiDescription) document.getElementById('kpiDescription').value = data.kpiDescription;
                    if (data.kpiObjective) document.getElementById('kpiObjective').value = data.kpiObjective;
                    
                    // Seleccionar proceso si está en los datos
                    if (data.selectedProcess) {
                        const processItem = document.querySelector(`.process-item[data-process="${data.selectedProcess}"]`);
                        if (processItem) {
                            processItem.classList.add('selected');
                            selectedProcessInput.value = data.selectedProcess;
                        }
                    }
                    
                    if (data.variables) document.getElementById('variables').value = data.variables;
                    if (data.measurementUnit) document.getElementById('measurementUnit').value = data.measurementUnit;
                    if (data.formula) document.getElementById('formula').value = data.formula;
                    if (data.frequency) document.getElementById('frequency').value = data.frequency;
                    if (data.targetValue) document.getElementById('targetValue').value = data.targetValue;
                    if (data.minValue) document.getElementById('minValue').value = data.minValue;
                    if (data.maxValue) document.getElementById('maxValue').value = data.maxValue;
                    if (data.toleranceRange) document.getElementById('toleranceRange').value = data.toleranceRange;
                    
                    // Seleccionar opción de SISGO si está en los datos
                    if (data.sisgoGrafico) {
                        const radio = document.querySelector(`input[name="sisgoGrafico"][value="${data.sisgoGrafico}"]`);
                        if (radio) radio.checked = true;
                    }
                    
                    if (data.utilidadComentario) document.getElementById('utilidadComentario').value = data.utilidadComentario;
                    if (data.designResponsible) document.getElementById('designResponsible').value = data.designResponsible;
                    if (data.implementationResponsible) document.getElementById('implementationResponsible').value = data.implementationResponsible;
                    if (data.monitoringResponsible) document.getElementById('monitoringResponsible').value = data.monitoringResponsible;
                    if (data.emailContact) document.getElementById('emailContact').value = data.emailContact;
                    
                    showAlert('Datos importados exitosamente desde CSV.', 'success');
                };
                
                reader.readAsText(file);
                // Limpiar el input para permitir importar el mismo archivo otra vez
                event.target.value = '';
            }
        });
    </script>
</body>
</html>
