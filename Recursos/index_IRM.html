<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carta de Control I-RM (Individual-Rango Móvil) - Con Límites de Especificación</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-gray: #f5f5f5;
            --border-color: #ddd;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: var(--light-gray);
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .card h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.secondary {
            background-color: #95a5a6;
        }
        
        button.secondary:hover {
            background-color: #7f8c8d;
        }
        
        button.success {
            background-color: var(--success-color);
        }
        
        button.success:hover {
            background-color: #219653;
        }
        
        button.warning {
            background-color: var(--warning-color);
        }
        
        button.warning:hover {
            background-color: #e67e22;
        }
        
        button.export-complete {
            background-color: #9b59b6;
        }
        
        button.export-complete:hover {
            background-color: #8e44ad;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 8px 10px;
            text-align: center;
        }
        
        th {
            background-color: var(--light-gray);
            font-weight: 600;
        }
        
      .sample-input {
    width: 120px;
    min-width: 80px;  /* Ancho mínimo */
    max-width: 200px; /* Ancho máximo */
    padding: 6px 8px;
    text-align: center;
    font-size: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
}

/* Para pantallas pequeñas */
@media (max-width: 768px) {
    .sample-input {
        width: 100px;
        padding: 4px 6px;
    }
}
}
        
        .chart-container {
            margin: 30px 0;
            height: 300px;
            position: relative;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .formula-explanation {
            margin-top: 30px;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 5px;
        }
        
        .formula-explanation h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .formula-item {
            margin-bottom: 15px;
        }
        
        .formula-item h4 {
            margin-bottom: 5px;
            color: var(--secondary-color);
        }
        
        .copyright {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: #777;
            font-size: 0.9rem;
        }
        
        .error {
            color: var(--accent-color);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .success {
            color: var(--success-color);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .warning {
            color: var(--warning-color);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .data-section {
            overflow-x: auto;
        }
        
        .sample-header {
            background-color: #e8f4f8;
            font-weight: bold;
        }
        
        .capability-interpretation {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
            border-left: 4px solid var(--secondary-color);
        }
        
        .capability-good {
            border-left-color: var(--success-color);
            background-color: #e8f5e8;
        }
        
        .capability-warning {
            border-left-color: var(--warning-color);
            background-color: #fef9e7;
        }
        
        .capability-poor {
            border-left-color: var(--accent-color);
            background-color: #fdeaea;
        }
        
        .interpretation-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .process-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-excellent {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-acceptable {
            background-color: #2ecc71;
            color: white;
        }
        
        .status-marginal {
            background-color: var(--warning-color);
            color: white;
        }
        
        .status-poor {
            background-color: var(--accent-color);
            color: white;
        }
        
        .spec-status {
            font-size: 0.8rem;
            margin-top: 5px;
            font-style: italic;
        }
        
        .spec-applied {
            color: var(--success-color);
        }
        
        .spec-missing {
            color: var(--warning-color);
        }
        
        .export-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .export-section h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .export-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .modal h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .file-input-container {
            margin-bottom: 15px;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .file-input-label:hover {
            background-color: #2980b9;
        }
        
        .file-input {
            display: none;
        }
        
        .file-info {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Nuevos estilos para mejoras */
        .parameter-explanation {
            background-color: #e8f4f8;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .parameter-title {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid var(--secondary-color);
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .summary-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .control-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
        
        .in-control {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        
        .out-of-control-status {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }
        
        .data-table-container {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }
        
        .sticky-header th {
            position: sticky;
            top: 0;
            background-color: var(--light-gray);
            z-index: 10;
        }
        
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Nuevos estilos para configuración de eje horizontal */
        .time-config-section {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary-color);
        }

        .time-config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .time-format-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .fixed-limits-info {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .limits-fixed {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
        }

        .csv-format-info {
            background-color: #e8f5e8;
            border: 1px solid #c8e6c9;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .metadata-display {
            font-size: 0.8rem;
            color: #666;
            margin-top: 2px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Carta de Control I-RM (Individual-Rango Móvil) - Con Límites de Especificación</h1>
            <p>Herramienta para monitoreo y control de procesos estadísticos con datos individuales</p>
        </header>
        
        <!-- Panel de Resumen -->
        <div class="dashboard-summary" id="dashboard-summary">
            <div class="summary-card">
                <div class="summary-label">Estado del Proceso</div>
                <div class="summary-value" id="process-status-value">-</div>
                <div class="summary-label" id="process-status-label">Sin datos</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Capacidad (Cpk)</div>
                <div class="summary-value" id="cpk-summary">-</div>
                <div class="summary-label" id="cpk-status">No calculado</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Observaciones</div>
                <div class="summary-value" id="observations-count">0</div>
                <div class="summary-label">Total registradas</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Rangos Móviles</div>
                <div class="summary-value" id="ranges-count">0</div>
                <div class="summary-label">Total calculados</div>
            </div>
        </div>

        <!-- Nueva sección: Configuración de Eje Horizontal y Límites Fijos -->
        <div class="card">
            <h2>Configuración de Escala de Tiempo y Límites</h2>
            
            <div class="time-config-section">
                <div class="parameter-title">Configuración del Eje Horizontal</div>
                <p>Seleccione la escala de tiempo para el análisis de su proceso</p>
                
                <div class="time-config-grid">
                    <div class="form-group">
                        <label for="time-scale">Escala de Tiempo:</label>
                        <select id="time-scale">
                            <option value="observation">Número de Observación</option>
                            <option value="date">Fecha</option>
                            <option value="day">Día</option>
                            <option value="week">Semana</option>
                            <option value="month">Mes</option>
                            <option value="year">Año</option>
                            <option value="metadata">Usar Metadatos del CSV</option>
                        </select>
                        <div class="time-format-info" id="time-format-info">
                            El eje X mostrará el número secuencial de observación
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="time-format">Formato de Etiqueta:</label>
                        <select id="time-format">
                            <option value="sequential">Secuencial (1, 2, 3...)</option>
                            <option value="custom">Personalizado</option>
                        </select>
                        <div class="time-format-info">
                            Formato de las etiquetas en el eje horizontal
                        </div>
                    </div>
                </div>
            </div>

            <div class="time-config-section">
                <div class="parameter-title">Configuración de Límites de Control</div>
                <p>Los límites se calcularán con los primeros 20 registros y permanecerán fijos</p>
                
                <div class="form-group">
                    <label for="limit-calculation-mode">Modo de Cálculo de Límites:</label>
                    <select id="limit-calculation-mode">
                        <option value="fixed">Límites Fijos (primeros 20 registros)</option>
                        <option value="dynamic">Límites Dinámicos (todos los registros)</option>
                    </select>
                    <div class="time-format-info">
                        En modo fijo, los límites se calculan una vez y permanecen constantes
                    </div>
                </div>
                
                <div id="fixed-limits-info" class="fixed-limits-info">
                    <strong>Límites Fijos Activados:</strong> Los límites de control se calcularán con los primeros 20 registros y se mantendrán constantes para el seguimiento. Ideal para detectar cambios en el proceso.
                </div>
            </div>
        </div>
        
        <div class="input-section">
            <div class="card">
                <h2>Configuración del Proceso</h2>
                
                <div class="parameter-explanation">
                    <div class="parameter-title">Datos Individuales</div>
                    <p>En la carta I-RM, cada observación representa una medición individual del proceso. Los rangos móviles se calculan entre observaciones consecutivas.</p>
                </div>
                
                <div class="parameter-explanation">
                    <div class="parameter-title">k (Límites de control)</div>
                    <p>Define el ancho de los límites de control. k=3 significa límites a ±3 desviaciones estándar (99.73% de datos).</p>
                </div>
                
                <div class="form-group">
                    <label for="k-value">Valor k (para límites de control):</label>
                    <input type="number" id="k-value" value="3" step="0.1" min="1" max="5">
                </div>
                
                <div class="form-group">
                    <label for="process-name">Nombre del Proceso:</label>
                    <input type="text" id="process-name" placeholder="Ej: Espesor (mm)">
                </div>
                
                <div class="form-group">
                    <label for="usl">Límite Superior de Especificación (USL):</label>
                    <input type="number" id="usl" placeholder="Opcional">
                    <div id="usl-status" class="spec-status"></div>
                </div>
                <div class="form-group">
                    <label for="lsl">Límite Inferior de Especificación (LSL):</label>
                    <input type="number" id="lsl" placeholder="Opcional">
                    <div id="lsl-status" class="spec-status"></div>
                </div>
                <div class="form-group">
                    <button id="add-observation-btn" class="secondary">Agregar Observación</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Instrucciones</h2>
                <p>1. Ingrese los datos individuales del proceso en la tabla.</p>
                <p>2. El rango móvil (RM) se calculará automáticamente entre observaciones consecutivas.</p>
                <p>3. Haga clic en "Calcular Carta de Control" para generar los gráficos.</p>
                <p>4. Los límites USL y LSL se mostrarán como líneas rojas en el gráfico I.</p>
                <p>5. La carta I-RM es útil para procesos con mediciones individuales o cuando la producción es lenta.</p>
                
                <div class="csv-format-info">
                    <strong>Formato CSV:</strong> Use dos columnas separadas por coma:<br>
                    <strong>Columna 1:</strong> Valor numérico de la medición<br>
                    <strong>Columna 2:</strong> Metadatos (fecha, lote, máquina, etc.)<br>
                    <em>Ejemplo: 25.4,2024-01-15 o 0.125,Lote-A</em>
                </div>
                
                <button id="calculate-btn">Calcular Carta de Control</button>
                <button id="clear-data" class="secondary">Limpiar Datos</button>
                <button id="import-data-btn" class="warning">Importar desde CSV</button>
                <button id="export-csv-btn" class="success">Exportar a CSV</button>
            </div>
        </div>
        
        <div class="card">
            <h2>Datos Individuales y Rangos Móviles</h2>
            <div class="data-section">
                <div class="data-table-container">
                    <table id="data-table">
                        <thead>
                            <tr id="table-header" class="sticky-header">
                                <!-- Los encabezados se generarán dinámicamente -->
                            </tr>
                        </thead>
                        <tbody id="data-body">
                            <!-- Las filas de datos se agregarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Estado de Control del Proceso -->
        <div class="card">
            <h2>Estado del Control del Proceso</h2>
            <div id="control-status" class="control-status">
                Estado del proceso: Sin datos suficientes para evaluación
            </div>
            <div id="control-analysis" style="margin-top: 15px;">
                <p>Puntos fuera de control: <span id="out-of-control-count">0</span></p>
                <p>Puntos fuera de especificación: <span id="out-of-spec-count">0</span></p>
                <p>Modo de límites: <span id="limits-mode-info">No calculado</span></p>
                <p>Recomendaciones: <span id="recommendations">Ingrese más datos para obtener recomendaciones</span></p>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="card">
                <h2>Estadísticas del Proceso</h2>
                <div id="process-stats">
                    <p>Media de rangos móviles (R̄): <span id="mr-bar">-</span></p>
                    <p>Media del proceso (μ̂): <span id="process-mean">-</span></p>
                    <p>Desviación estándar (σ̂): <span id="process-std">-</span></p>
                    <p>Registros para límites: <span id="limits-base-count">-</span></p>
                </div>
            </div>
            
            <div class="card">
                <h2>Capacidad del Proceso</h2>
                <div id="process-capability">
                    <p>C<sub>p</sub>: <span id="cp-value">-</span></p>
                    <p>C<sub>pk</sub>: <span id="cpk-value">-</span></p>
                    <p>Rendimiento (%): <span id="yield-percent">-</span></p>
                    <div id="capability-interpretation">
                        <!-- La interpretación se generará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Carta de Control I (Individual) con Límites de Especificación</h2>
            <div class="chart-container">
                <canvas id="i-chart"></canvas>
            </div>
            <div class="chart-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(54, 162, 235);"></div>
                    <span>Observación Individual (I)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(0, 0, 0); border: 1px dashed #000;"></div>
                    <span>Línea Central (CL)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(220, 53, 69); border: 1px dashed #dc3545;"></div>
                    <span>Límites de Control (UCL/LCL)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(255, 0, 0);"></div>
                    <span>Límites de Especificación (USL/LSL)</span>
                </div>
            </div>
            <div id="i-limits">
                <p>Línea Central (CL): <span id="i-cl">-</span></p>
                <p>Límite Superior de Control (UCL): <span id="i-ucl">-</span></p>
                <p>Límite Inferior de Control (LCL): <span id="i-lcl">-</span></p>
                <p>Límite Superior de Especificación (USL): <span id="i-usl">-</span></p>
                <p>Límite Inferior de Especificación (LSL): <span id="i-lsl">-</span></p>
                <p><strong>Base para límites:</strong> <span id="i-limits-base">-</span></p>
            </div>
        </div>
        
        <div class="card">
            <h2>Carta de Control RM (Rango Móvil)</h2>
            <div class="chart-container">
                <canvas id="rm-chart"></canvas>
            </div>
            <div class="chart-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(255, 159, 64);"></div>
                    <span>Rango Móvil (RM)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(0, 0, 0); border: 1px dashed #000;"></div>
                    <span>Línea Central (CL)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(220, 53, 69); border: 1px dashed #dc3545;"></div>
                    <span>Límites de Control (UCL/LCL)</span>
                </div>
            </div>
            <div id="rm-limits">
                <p>Línea Central (CL): <span id="rm-cl">-</span></p>
                <p>Límite Superior de Control (UCL): <span id="rm-ucl">-</span></p>
                <p>Límite Inferior de Control (LCL): <span id="rm-lcl">-</span></p>
                <p><strong>Base para límites:</strong> <span id="rm-limits-base">-</span></p>
            </div>
        </div>
        
        <div class="export-section">
            <h3>Exportar Reporte</h3>
            <div class="export-buttons">
                <button id="export-complete-pdf-btn" class="export-complete">Exportar PDF Completo</button>
                <button id="export-pdf-btn" class="success">Generar PDF Ejecutivo</button>
                <button id="send-email-btn" class="warning">Enviar por Correo</button>
            </div>
        </div>
        
        <div class="copyright">
            <p>© 2023 Carta de Control I-RM (Individual-Rango Móvil) - Con Límites de Especificación</p>
        </div>
    </div>

    <!-- Modal para importación de datos -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <h3>Importar Datos desde Archivo CSV</h3>
            <div class="file-input-container">
                <label for="file-input" class="file-input-label">Seleccionar archivo CSV</label>
                <input type="file" id="file-input" class="file-input" accept=".csv">
                <div class="file-info" id="file-info">No se ha seleccionado ningún archivo</div>
            </div>
            <div class="form-group">
                <label for="csv-delimiter">Separador (para archivos CSV):</label>
                <select id="csv-delimiter">
                    <option value=",">Coma (,)</option>
                    <option value=";">Punto y coma (;)</option>
                    <option value="\t">Tabulador</option>
                </select>
            </div>
            <div class="form-group">
                <label for="csv-has-headers">El archivo tiene encabezados:</label>
                <select id="csv-has-headers">
                    <option value="true">Sí</option>
                    <option value="false">No</option>
                </select>
            </div>
            <div class="csv-format-info">
                <strong>Formato esperado:</strong><br>
                <strong>Columna 1:</strong> Valor numérico<br>
                <strong>Columna 2:</strong> Metadatos (fecha, lote, máquina, etc.)<br>
                <em>Ejemplo: 25.4,2024-01-15</em>
            </div>
            <div class="modal-buttons">
                <button id="cancel-import" class="secondary">Cancelar</button>
                <button id="confirm-import" class="success">Importar</button>
            </div>
        </div>
    </div>

    <!-- Modal para envío por correo -->
    <div id="email-modal" class="modal">
        <div class="modal-content">
            <h3>Enviar Reporte Ejecutivo por Correo</h3>
            <div class="form-group">
                <label for="email-to">Destinatario:</label>
                <input type="email" id="email-to" value="jtxdossier@gmail.com">
            </div>
            <div class="form-group">
                <label for="email-subject">Asunto:</label>
                <input type="text" id="email-subject" value="Reporte Ejecutivo - Carta de Control I-RM">
            </div>
            <div class="form-group">
                <label for="email-message">Mensaje:</label>
                <textarea id="email-message" rows="4" placeholder="Mensaje opcional..."></textarea>
            </div>
            <div class="modal-buttons">
                <button id="cancel-email" class="secondary">Cancelar</button>
                <button id="send-email" class="success">Enviar Reporte</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Constantes para factores d2 y d3 para rangos móviles (n=2)
        const d2 = 1.128; // Factor d2 para n=2 (rangos móviles)
        const d3 = 0.853; // Factor d3 para n=2 (rangos móviles)
        
        // Variables globales
        let observationCounter = 1;
        let iChart, rmChart;
        let fixedLimits = null; // Almacenará los límites fijos calculados
        let limitsBaseCount = 0; // Número de registros usados para calcular límites
        let metadataLabels = []; // Almacenará los metadatos para el eje X
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Reconstruir encabezado de tabla
            rebuildTableHeader();
            
            // Agregar observación inicial
            addObservation();
            
            // Configurar eventos
            document.getElementById('add-observation-btn').addEventListener('click', addObservation);
            document.getElementById('calculate-btn').addEventListener('click', calculateControlChart);
            document.getElementById('clear-data').addEventListener('click', clearData);
            document.getElementById('import-data-btn').addEventListener('click', showImportModal);
            document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
            document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
            document.getElementById('send-email-btn').addEventListener('click', showEmailModal);
            
            // Evento para exportación completa
            document.getElementById('export-complete-pdf-btn').addEventListener('click', exportCompletePDF);
            
            // Eventos para modales
            document.getElementById('cancel-import').addEventListener('click', hideImportModal);
            document.getElementById('confirm-import').addEventListener('click', importDataFromFile);
            document.getElementById('file-input').addEventListener('change', updateFileInfo);
            document.getElementById('cancel-email').addEventListener('click', hideEmailModal);
            document.getElementById('send-email').addEventListener('click', sendEmail);
            
            // Monitorear cambios en los límites de especificación
            document.getElementById('usl').addEventListener('input', updateSpecStatus);
            document.getElementById('lsl').addEventListener('input', updateSpecStatus);
            
            // Nuevos eventos para configuración de tiempo y límites
            document.getElementById('time-scale').addEventListener('change', updateTimeScaleInfo);
            document.getElementById('time-format').addEventListener('change', updateTimeFormatInfo);
            document.getElementById('limit-calculation-mode').addEventListener('change', updateLimitModeInfo);
            
            // Inicializar gráficos
            initializeCharts();
            
            // Actualizar estado inicial de especificaciones
            updateSpecStatus();
            updateTimeScaleInfo();
            updateLimitModeInfo();
            
            // Actualizar resumen inicial
            updateDashboardSummary();
        });
        
        // Actualizar información de escala de tiempo
        function updateTimeScaleInfo() {
            const timeScale = document.getElementById('time-scale').value;
            const infoElement = document.getElementById('time-format-info');
            
            const scaleInfo = {
                'observation': 'El eje X mostrará el número secuencial de observación',
                'date': 'El eje X mostrará fechas en formato DD/MM/AAAA',
                'day': 'El eje X mostrará días consecutivos',
                'week': 'El eje X mostrará semanas consecutivas',
                'month': 'El eje X mostrará meses consecutivos',
                'year': 'El eje X mostrará años consecutivos',
                'metadata': 'El eje X mostrará los metadatos importados del CSV'
            };
            
            infoElement.textContent = scaleInfo[timeScale] || scaleInfo['observation'];
        }
        
        // Actualizar información de formato de tiempo
        function updateTimeFormatInfo() {
            // Puede expandirse para mostrar diferentes formatos según la selección
        }
        
        // Actualizar información de modo de límites
        function updateLimitModeInfo() {
            const limitMode = document.getElementById('limit-calculation-mode').value;
            const infoElement = document.getElementById('fixed-limits-info');
            
            if (limitMode === 'fixed') {
                infoElement.innerHTML = '<strong>Límites Fijos Activados:</strong> Los límites de control se calcularán con los primeros 20 registros y se mantendrán constantes para el seguimiento. Ideal para detectar cambios en el proceso.';
                infoElement.className = 'fixed-limits-info limits-fixed';
            } else {
                infoElement.innerHTML = '<strong>Límites Dinámicos Activados:</strong> Los límites de control se recalcularán con todos los registros disponibles cada vez que se agreguen nuevos datos.';
                infoElement.className = 'fixed-limits-info';
            }
        }
        
        // Generar etiquetas para el eje X según la configuración
        function generateXAxisLabels(count) {
            const timeScale = document.getElementById('time-scale').value;
            const timeFormat = document.getElementById('time-format').value;
            const labels = [];
            
            // Si hay metadatos y se seleccionó usar metadatos, usar esos
            if (timeScale === 'metadata' && metadataLabels.length > 0) {
                return metadataLabels.slice(0, count);
            }
            
            if (timeFormat === 'sequential') {
                for (let i = 1; i <= count; i++) {
                    labels.push(i.toString());
                }
            } else {
                // Personalizado según la escala de tiempo
                const now = new Date();
                
                for (let i = 1; i <= count; i++) {
                    let label;
                    switch(timeScale) {
                        case 'date':
                            const date = new Date(now);
                            date.setDate(now.getDate() + i - 1);
                            label = date.toLocaleDateString();
                            break;
                        case 'day':
                            label = `Día ${i}`;
                            break;
                        case 'week':
                            label = `Semana ${i}`;
                            break;
                        case 'month':
                            label = `Mes ${i}`;
                            break;
                        case 'year':
                            label = `Año ${i}`;
                            break;
                        default:
                            label = i.toString();
                    }
                    labels.push(label);
                }
            }
            
            return labels;
        }
        
        // NUEVA FUNCIÓN: Exportar a CSV con dos columnas
        function exportToCSV() {
            const rows = document.querySelectorAll('#data-body tr');
            const data = [];
            
            // Encabezados
            data.push(['Valor', 'Metadatos']);
            
            // Datos
            rows.forEach(row => {
                const valueInput = row.querySelector('.sample-input');
                const metadataInput = row.querySelector('.metadata-input');
                
                if (valueInput && valueInput.value) {
                    const value = valueInput.value;
                    const metadata = metadataInput ? metadataInput.value : '';
                    data.push([value, metadata]);
                }
            });
            
            // Crear contenido CSV
            let csvContent = '';
            data.forEach(row => {
                csvContent += row.map(field => `"${field}"`).join(',') + '\n';
            });
            
            // Crear y descargar archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `datos_proceso_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // NUEVA FUNCIÓN: Exportar TODO el contenido visible a PDF
        function exportCompletePDF() {
            // Verificar si las bibliotecas están disponibles
            if (typeof jspdf === 'undefined') {
                alert('Error: La biblioteca jsPDF no está cargada correctamente');
                return;
            }
            
            if (typeof html2canvas === 'undefined') {
                alert('Error: La biblioteca html2canvas no está cargada correctamente');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const processName = document.getElementById('process-name').value || 'Proceso Sin Nombre';
            const now = new Date();
            
            // Mostrar mensaje de procesamiento
            const processingMsg = document.createElement('div');
            processingMsg.style.position = 'fixed';
            processingMsg.style.top = '50%';
            processingMsg.style.left = '50%';
            processingMsg.style.transform = 'translate(-50%, -50%)';
            processingMsg.style.backgroundColor = 'rgba(0,0,0,0.8)';
            processingMsg.style.color = 'white';
            processingMsg.style.padding = '20px';
            processingMsg.style.borderRadius = '5px';
            processingMsg.style.zIndex = '10000';
            processingMsg.textContent = 'Generando PDF completo... Esto puede tomar unos segundos.';
            document.body.appendChild(processingMsg);
            
            // Obtener el elemento contenedor principal
            const container = document.querySelector('.container');
            
            // Configuración para html2canvas
            const options = {
                scale: 2, // Mayor resolución
                useCORS: true,
                allowTaint: true,
                scrollX: 0,
                scrollY: -window.scrollY,
                width: container.scrollWidth,
                height: container.scrollHeight,
                windowWidth: container.scrollWidth,
                windowHeight: container.scrollHeight
            };
            
            // Capturar el contenido como imagen
            html2canvas(container, options).then(canvas => {
                // Eliminar mensaje de procesamiento
                document.body.removeChild(processingMsg);
                
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                const imgWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                let heightLeft = imgHeight;
                let position = 0;
                
                // Agregar primera página
                doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // Agregar páginas adicionales si es necesario
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Guardar el PDF
                doc.save(`Registro_Completo_${processName.replace(/\s+/g, '_')}_${now.getTime()}.pdf`);
                
            }).catch(error => {
                // Eliminar mensaje de procesamiento en caso de error
                if (document.body.contains(processingMsg)) {
                    document.body.removeChild(processingMsg);
                }
                
                console.error('Error al generar PDF completo:', error);
                alert('Error al generar el PDF completo: ' + error.message);
                
                // Fallback: intentar con opciones más simples
                try {
                    html2canvas(container, { scale: 1 }).then(canvas => {
                        const imgData = canvas.toDataURL('image/jpeg', 0.9);
                        const imgWidth = doc.internal.pageSize.getWidth();
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                        doc.save(`Registro_Completo_${processName.replace(/\s+/g, '_')}_${now.getTime()}.pdf`);
                    });
                } catch (fallbackError) {
                    alert('No se pudo generar el PDF completo. Error: ' + fallbackError.message);
                }
            });
        }
        
        // Reconstruir encabezado de tabla
        function rebuildTableHeader() {
            const tableHeader = document.getElementById('table-header');
            tableHeader.innerHTML = '';
            
            // Agregar columna de observación
            const obsHeader = document.createElement('th');
            obsHeader.textContent = 'Observación';
            tableHeader.appendChild(obsHeader);
            
            // Agregar columna para valor individual
            const valueHeader = document.createElement('th');
            valueHeader.textContent = 'Valor Individual (I)';
            tableHeader.appendChild(valueHeader);
            
            // NUEVA: Agregar columna para metadatos
            const metadataHeader = document.createElement('th');
            metadataHeader.textContent = 'Metadatos (Fecha/Lote/Máquina)';
            tableHeader.appendChild(metadataHeader);
            
            // Agregar columna para rango móvil
            const rangeHeader = document.createElement('th');
            rangeHeader.textContent = 'Rango Móvil (RM)';
            tableHeader.appendChild(rangeHeader);
        }
        
        // Agregar nueva observación
        function addObservation() {
            const dataBody = document.getElementById('data-body');
            const newRow = document.createElement('tr');
            
            // Celda de número de observación
            const obsCell = document.createElement('td');
            obsCell.textContent = observationCounter;
            newRow.appendChild(obsCell);
            
            // Celda para valor individual
            const inputCell = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'sample-input';
            input.step = 'any';
            input.addEventListener('input', function() {
                calculateMovingRanges();
                updateDashboardSummary();
            });
            inputCell.appendChild(input);
            newRow.appendChild(inputCell);
            
            // NUEVA: Celda para metadatos
            const metadataCell = document.createElement('td');
            const metadataInput = document.createElement('input');
            metadataInput.type = 'text';
            metadataInput.className = 'metadata-input';
            metadataInput.placeholder = 'Fecha/Lote/Máquina...';
            metadataInput.addEventListener('input', function() {
                updateDashboardSummary();
            });
            metadataCell.appendChild(metadataInput);
            newRow.appendChild(metadataCell);
            
            // Celda para rango móvil
            const rangeCell = document.createElement('td');
            rangeCell.className = 'moving-range';
            rangeCell.textContent = '-';
            newRow.appendChild(rangeCell);
            
            dataBody.appendChild(newRow);
            observationCounter++;
            
            // Recalcular rangos móviles
            calculateMovingRanges();
            updateDashboardSummary();
        }
        
        // Calcular rangos móviles
        function calculateMovingRanges() {
            const rows = document.querySelectorAll('#data-body tr');
            
            // Limpiar todos los rangos móviles
            rows.forEach(row => {
                row.querySelector('.moving-range').textContent = '-';
            });
            
            // Calcular rangos móviles para observaciones consecutivas
            for (let i = 1; i < rows.length; i++) {
                const currentRow = rows[i];
                const previousRow = rows[i-1];
                
                const currentInput = currentRow.querySelector('.sample-input');
                const previousInput = previousRow.querySelector('.sample-input');
                
                const currentValue = parseFloat(currentInput.value);
                const previousValue = parseFloat(previousInput.value);
                
                if (!isNaN(currentValue) && !isNaN(previousValue)) {
                    const movingRange = Math.abs(currentValue - previousValue);
                    currentRow.querySelector('.moving-range').textContent = movingRange.toFixed(4);
                }
            }
        }
        
        // Calcular carta de control
        function calculateControlChart() {
            const individualValues = [];
            const movingRanges = [];
            const observationNumbers = [];
            metadataLabels = []; // Reiniciar metadatos
            
            // Recopilar datos de todas las observaciones
            const rows = document.querySelectorAll('#data-body tr');
            
            rows.forEach(row => {
                const input = row.querySelector('.sample-input');
                const metadataInput = row.querySelector('.metadata-input');
                const rangeCell = row.querySelector('.moving-range');
                
                if (input.value && !isNaN(parseFloat(input.value))) {
                    individualValues.push(parseFloat(input.value));
                    observationNumbers.push(parseInt(row.cells[0].textContent));
                    
                    // Guardar metadatos si existen
                    if (metadataInput && metadataInput.value) {
                        metadataLabels.push(metadataInput.value);
                    } else {
                        metadataLabels.push(`Obs ${observationNumbers[observationNumbers.length-1]}`);
                    }
                    
                    // Solo agregar rangos móviles válidos (no la primera observación)
                    if (rangeCell.textContent !== '-') {
                        movingRanges.push(parseFloat(rangeCell.textContent));
                    }
                }
            });
            
            // Verificar si hay datos suficientes
            if (individualValues.length < 2) {
                alert('Se necesitan al menos 2 observaciones con datos para calcular la carta de control');
                return;
            }
            
            // Determinar si usar límites fijos o dinámicos
            const limitMode = document.getElementById('limit-calculation-mode').value;
            let useFixedLimits = false;
            let dataForLimits = individualValues;
            let movingRangesForLimits = movingRanges;
            
            if (limitMode === 'fixed' && individualValues.length >= 20) {
                useFixedLimits = true;
                dataForLimits = individualValues.slice(0, 20);
                movingRangesForLimits = movingRanges.slice(0, 19); // Los rangos móviles son uno menos
            }
            
            // Calcular estadísticas del proceso
            const mrBar = movingRangesForLimits.reduce((sum, mr) => sum + mr, 0) / movingRangesForLimits.length;
            const processMean = dataForLimits.reduce((sum, value) => sum + value, 0) / dataForLimits.length;
            
            // Calcular desviación estándar usando rangos móviles
            const processStd = mrBar / d2;
            
            // Obtener valor k
            const k = parseFloat(document.getElementById('k-value').value);
            
            // Calcular límites de control para I (Individual)
            const iUCL = processMean + k * processStd;
            const iLCL = processMean - k * processStd;
            
            // Calcular límites de control para RM (Rango Móvil)
            const rmUCL = mrBar * (1 + k * (d3 / d2));
            const rmLCL = Math.max(0, mrBar * (1 - k * (d3 / d2)));
            
            // Almacenar límites fijos si es necesario
            if (useFixedLimits && !fixedLimits) {
                fixedLimits = {
                    processMean: processMean,
                    processStd: processStd,
                    mrBar: mrBar,
                    iUCL: iUCL,
                    iLCL: iLCL,
                    rmUCL: rmUCL,
                    rmLCL: rmLCL,
                    baseCount: dataForLimits.length
                };
                limitsBaseCount = dataForLimits.length;
            }
            
            // Usar límites fijos si están disponibles y estamos en modo fijo
            let finalProcessMean, finalProcessStd, finalMrBar, finalIUCL, finalILCL, finalRmUCL, finalRmLCL;
            
            if (useFixedLimits && fixedLimits) {
                finalProcessMean = fixedLimits.processMean;
                finalProcessStd = fixedLimits.processStd;
                finalMrBar = fixedLimits.mrBar;
                finalIUCL = fixedLimits.iUCL;
                finalILCL = fixedLimits.iLCL;
                finalRmUCL = fixedLimits.rmUCL;
                finalRmLCL = fixedLimits.rmLCL;
                limitsBaseCount = fixedLimits.baseCount;
            } else {
                finalProcessMean = processMean;
                finalProcessStd = processStd;
                finalMrBar = mrBar;
                finalIUCL = iUCL;
                finalILCL = iLCL;
                finalRmUCL = rmUCL;
                finalRmLCL = rmLCL;
                limitsBaseCount = dataForLimits.length;
            }
            
            // Obtener límites de especificación
            const usl = document.getElementById('usl').value ? parseFloat(document.getElementById('usl').value) : null;
            const lsl = document.getElementById('lsl').value ? parseFloat(document.getElementById('lsl').value) : null;
            
            // Detectar puntos fuera de control y fuera de especificación
            let outOfControlCount = 0;
            let outOfSpecCount = 0;
            
            individualValues.forEach(value => {
                if (value > finalIUCL || value < finalILCL) {
                    outOfControlCount++;
                }
                if (usl !== null && value > usl) {
                    outOfSpecCount++;
                }
                if (lsl !== null && value < lsl) {
                    outOfSpecCount++;
                }
            });
            
            movingRanges.forEach(range => {
                if (range > finalRmUCL || (finalRmLCL > 0 && range < finalRmLCL)) {
                    outOfControlCount++;
                }
            });
            
            // Actualizar estadísticas en la interfaz
            document.getElementById('mr-bar').textContent = finalMrBar.toFixed(4);
            document.getElementById('process-mean').textContent = finalProcessMean.toFixed(4);
            document.getElementById('process-std').textContent = finalProcessStd.toFixed(4);
            document.getElementById('limits-base-count').textContent = `${limitsBaseCount} registros`;
            
            document.getElementById('i-cl').textContent = finalProcessMean.toFixed(4);
            document.getElementById('i-ucl').textContent = finalIUCL.toFixed(4);
            document.getElementById('i-lcl').textContent = finalILCL.toFixed(4);
            document.getElementById('i-usl').textContent = usl !== null ? usl.toFixed(4) : '-';
            document.getElementById('i-lsl').textContent = lsl !== null ? lsl.toFixed(4) : '-';
            document.getElementById('i-limits-base').textContent = useFixedLimits ? 
                `Límites fijos (primeros ${limitsBaseCount} registros)` : 
                `Límites dinámicos (${limitsBaseCount} registros)`;
            
            document.getElementById('rm-cl').textContent = finalMrBar.toFixed(4);
            document.getElementById('rm-ucl').textContent = finalRmUCL.toFixed(4);
            document.getElementById('rm-lcl').textContent = finalRmLCL > 0 ? finalRmLCL.toFixed(4) : '0';
            document.getElementById('rm-limits-base').textContent = useFixedLimits ? 
                `Límites fijos (primeros ${limitsBaseCount} registros)` : 
                `Límites dinámicos (${limitsBaseCount} registros)`;
            
            // Actualizar estado de control
            const controlStatus = document.getElementById('control-status');
            const outOfControlElement = document.getElementById('out-of-control-count');
            const outOfSpecElement = document.getElementById('out-of-spec-count');
            const limitsModeElement = document.getElementById('limits-mode-info');
            const recommendationsElement = document.getElementById('recommendations');
            
            outOfControlElement.textContent = outOfControlCount;
            outOfSpecElement.textContent = outOfSpecCount;
            limitsModeElement.textContent = useFixedLimits ? 
                `Límites fijos (base: ${limitsBaseCount} registros)` : 
                `Límites dinámicos (${limitsBaseCount} registros)`;
            
            if (outOfControlCount === 0 && outOfSpecCount === 0) {
                controlStatus.textContent = 'Estado del proceso: Bajo Control Estadístico';
                controlStatus.className = 'control-status in-control';
                recommendationsElement.textContent = 'El proceso está bajo control estadístico. Continúe monitoreando.';
            } else {
                controlStatus.textContent = 'Estado del proceso: Fuera de Control';
                controlStatus.className = 'control-status out-of-control-status';
                
                let recommendations = '';
                if (outOfControlCount > 0) {
                    recommendations += 'Existen puntos fuera de los límites de control. Investigue causas especiales. ';
                }
                if (outOfSpecCount > 0) {
                    recommendations += 'Existen observaciones fuera de especificación. Revise el proceso.';
                }
                recommendationsElement.textContent = recommendations;
            }
            
            // Calcular capacidad del proceso si hay especificaciones
            if (usl !== null && lsl !== null) {
                calculateProcessCapability(finalProcessMean, finalProcessStd, usl, lsl, individualValues);
            } else {
                document.getElementById('cp-value').textContent = '-';
                document.getElementById('cpk-value').textContent = '-';
                document.getElementById('yield-percent').textContent = '-';
                document.getElementById('capability-interpretation').innerHTML = 
                    '<p>Ingrese ambos límites de especificación para calcular la capacidad del proceso.</p>';
            }
            
            // Generar etiquetas para el eje X
            const xAxisLabels = generateXAxisLabels(observationNumbers.length);
            
            // Actualizar gráficos
            updateIChart(xAxisLabels, individualValues, finalProcessMean, finalIUCL, finalILCL, usl, lsl);
            updateRMChart(xAxisLabels, movingRanges, finalMrBar, finalRmUCL, finalRmLCL);
            
            // Actualizar resumen del dashboard
            updateDashboardSummary();
        }
        
        // Calcular capacidad del proceso
        function calculateProcessCapability(mean, std, usl, lsl, values) {
            // Calcular Cp
            const cp = (usl - lsl) / (6 * std);
            
            // Calcular Cpk
            const cpu = (usl - mean) / (3 * std);
            const cpl = (mean - lsl) / (3 * std);
            const cpk = Math.min(cpu, cpl);
            
            // Calcular rendimiento
            const withinSpec = values.filter(value => value >= lsl && value <= usl).length;
            const yieldPercent = (withinSpec / values.length) * 100;
            
            // Actualizar interfaz
            document.getElementById('cp-value').textContent = cp.toFixed(4);
            document.getElementById('cpk-value').textContent = cpk.toFixed(4);
            document.getElementById('yield-percent').textContent = yieldPercent.toFixed(2);
            
            // Interpretar capacidad
            const interpretation = document.getElementById('capability-interpretation');
            let interpretationClass = '';
            let interpretationText = '';
            
            if (cpk >= 1.67) {
                interpretationClass = 'capability-good';
                interpretationText = 'Capacidad excelente. El proceso cumple con especificaciones con amplio margen.';
            } else if (cpk >= 1.33) {
                interpretationClass = 'capability-good';
                interpretationText = 'Capacidad adecuada. El proceso cumple con especificaciones.';
            } else if (cpk >= 1.0) {
                interpretationClass = 'capability-warning';
                interpretationText = 'Capacidad marginal. El proceso puede tener problemas para cumplir especificaciones.';
            } else if (cpk >= 0.67) {
                interpretationClass = 'capability-warning';
                interpretationText = 'Capacidad insuficiente. El proceso no cumple consistentemente con especificaciones.';
            } else {
                interpretationClass = 'capability-poor';
                interpretationText = 'Capacidad inaceptable. El proceso no cumple con especificaciones.';
            }
            
            interpretation.innerHTML = `
                <div class="capability-interpretation ${interpretationClass}">
                    <div class="interpretation-title">Interpretación:</div>
                    <div>${interpretationText}</div>
                </div>
            `;
            
            // Actualizar resumen del dashboard
            document.getElementById('cpk-summary').textContent = cpk.toFixed(2);
            document.getElementById('cpk-status').textContent = getCpkStatusText(cpk);
        }
        
        // Obtener texto de estado para Cpk
        function getCpkStatusText(cpk) {
            if (cpk >= 1.67) return 'Excelente';
            if (cpk >= 1.33) return 'Adecuado';
            if (cpk >= 1.0) return 'Marginal';
            if (cpk >= 0.67) return 'Insuficiente';
            return 'Inaceptable';
        }
        
        // Inicializar gráficos
        function initializeCharts() {
            const iCtx = document.getElementById('i-chart').getContext('2d');
            const rmCtx = document.getElementById('rm-chart').getContext('2d');
            
            // Configuración común para gráficos
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Observación'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Valor'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            };
            
            // Crear gráficos vacíos
            iChart = new Chart(iCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Observación Individual (I)',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1,
                            pointRadius: 4
                        },
                        {
                            label: 'Línea Central (CL)',
                            data: [],
                            borderColor: 'rgb(0, 0, 0)',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Límite Superior de Control (UCL)',
                            data: [],
                            borderColor: 'rgb(220, 53, 69)',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Límite Inferior de Control (LCL)',
                            data: [],
                            borderColor: 'rgb(220, 53, 69)',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Límite Superior de Especificación (USL)',
                            data: [],
                            borderColor: 'rgb(255, 0, 0)',
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Límite Inferior de Especificación (LSL)',
                            data: [],
                            borderColor: 'rgb(255, 0, 0)',
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: commonOptions
            });
            
            rmChart = new Chart(rmCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Rango Móvil (RM)',
                            data: [],
                            borderColor: 'rgb(255, 159, 64)',
                            backgroundColor: 'rgba(255, 159, 64, 0.1)',
                            tension: 0.1,
                            pointRadius: 4
                        },
                        {
                            label: 'Línea Central (CL)',
                            data: [],
                            borderColor: 'rgb(0, 0, 0)',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Límite Superior de Control (UCL)',
                            data: [],
                            borderColor: 'rgb(220, 53, 69)',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Límite Inferior de Control (LCL)',
                            data: [],
                            borderColor: 'rgb(220, 53, 69)',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: commonOptions
            });
        }
        
        // Actualizar gráfico I
        function updateIChart(labels, data, cl, ucl, lcl, usl, lsl) {
            // Preparar datos para el gráfico
            const clData = Array(data.length).fill(cl);
            const uclData = Array(data.length).fill(ucl);
            const lclData = Array(data.length).fill(lcl);
            const uslData = usl !== null ? Array(data.length).fill(usl) : [];
            const lslData = lsl !== null ? Array(data.length).fill(lsl) : [];
            
            // Actualizar gráfico
            iChart.data.labels = labels;
            iChart.data.datasets[0].data = data;
            iChart.data.datasets[1].data = clData;
            iChart.data.datasets[2].data = uclData;
            iChart.data.datasets[3].data = lclData;
            iChart.data.datasets[4].data = uslData;
            iChart.data.datasets[5].data = lslData;
            
            // Actualizar título del eje Y
            const processName = document.getElementById('process-name').value || 'Valor';
            iChart.options.scales.y.title.text = processName;
            
            // Actualizar título del eje X según la escala de tiempo
            const timeScale = document.getElementById('time-scale').value;
            const xAxisTitles = {
                'observation': 'Número de Observación',
                'date': 'Fecha',
                'day': 'Día',
                'week': 'Semana',
                'month': 'Mes',
                'year': 'Año',
                'metadata': 'Metadatos'
            };
            iChart.options.scales.x.title.text = xAxisTitles[timeScale] || 'Observación';
            
            iChart.update();
        }
        
        // Actualizar gráfico RM
        function updateRMChart(labels, data, cl, ucl, lcl) {
            // Nota: Los rangos móviles comienzan desde la segunda observación
            // Ajustar etiquetas para que coincidan
            const rmLabels = labels.slice(1);
            
            // Preparar datos para el gráfico
            const clData = Array(data.length).fill(cl);
            const uclData = Array(data.length).fill(ucl);
            const lclData = Array(data.length).fill(lcl);
            
            // Actualizar gráfico
            rmChart.data.labels = rmLabels;
            rmChart.data.datasets[0].data = data;
            rmChart.data.datasets[1].data = clData;
            rmChart.data.datasets[2].data = uclData;
            rmChart.data.datasets[3].data = lclData;
            
            // Actualizar título del eje X según la escala de tiempo
            const timeScale = document.getElementById('time-scale').value;
            const xAxisTitles = {
                'observation': 'Número de Observación',
                'date': 'Fecha',
                'day': 'Día',
                'week': 'Semana',
                'month': 'Mes',
                'year': 'Año',
                'metadata': 'Metadatos'
            };
            rmChart.options.scales.x.title.text = xAxisTitles[timeScale] || 'Observación';
            
            rmChart.update();
        }
        
        // Limpiar datos
        function clearData() {
            if (confirm('¿Está seguro de que desea eliminar todos los datos?')) {
                const dataBody = document.getElementById('data-body');
                dataBody.innerHTML = '';
                observationCounter = 1;
                addObservation();
                
                // Reiniciar límites fijos
                fixedLimits = null;
                limitsBaseCount = 0;
                metadataLabels = [];
                
                // Reiniciar gráficos
                iChart.data.labels = [];
                iChart.data.datasets.forEach(dataset => dataset.data = []);
                iChart.update();
                
                rmChart.data.labels = [];
                rmChart.data.datasets.forEach(dataset => dataset.data = []);
                rmChart.update();
                
                // Reiniciar estadísticas
                document.getElementById('mr-bar').textContent = '-';
                document.getElementById('process-mean').textContent = '-';
                document.getElementById('process-std').textContent = '-';
                document.getElementById('limits-base-count').textContent = '-';
                
                document.getElementById('i-cl').textContent = '-';
                document.getElementById('i-ucl').textContent = '-';
                document.getElementById('i-lcl').textContent = '-';
                document.getElementById('i-limits-base').textContent = '-';
                
                document.getElementById('rm-cl').textContent = '-';
                document.getElementById('rm-ucl').textContent = '-';
                document.getElementById('rm-lcl').textContent = '-';
                document.getElementById('rm-limits-base').textContent = '-';
                
                // Reiniciar estado de control
                document.getElementById('control-status').textContent = 'Estado del proceso: Sin datos suficientes para evaluación';
                document.getElementById('control-status').className = 'control-status';
                document.getElementById('out-of-control-count').textContent = '0';
                document.getElementById('out-of-spec-count').textContent = '0';
                document.getElementById('limits-mode-info').textContent = 'No calculado';
                document.getElementById('recommendations').textContent = 'Ingrese más datos para obtener recomendaciones';
                
                // Reiniciar capacidad
                document.getElementById('cp-value').textContent = '-';
                document.getElementById('cpk-value').textContent = '-';
                document.getElementById('yield-percent').textContent = '-';
                document.getElementById('capability-interpretation').innerHTML = '';
                
                // Actualizar resumen
                updateDashboardSummary();
            }
        }
        
        // Mostrar modal de importación
        function showImportModal() {
            document.getElementById('import-modal').style.display = 'flex';
        }
        
        // Ocultar modal de importación
        function hideImportModal() {
            document.getElementById('import-modal').style.display = 'none';
            document.getElementById('file-input').value = '';
            document.getElementById('file-info').textContent = 'No se ha seleccionado ningún archivo';
        }
        
        // Actualizar información del archivo
        function updateFileInfo() {
            const fileInput = document.getElementById('file-input');
            const fileInfo = document.getElementById('file-info');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileInfo.textContent = `Archivo seleccionado: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            } else {
                fileInfo.textContent = 'No se ha seleccionado ningún archivo';
            }
        }
        
       // Importar datos desde archivo CSV con dos columnas - VERSIÓN CORREGIDA
function importDataFromFile() {
    const fileInput = document.getElementById('file-input');
    
    if (fileInput.files.length === 0) {
        alert('Por favor, seleccione un archivo para importar');
        return;
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            const data = [];
            const metadata = [];
            const hasHeaders = document.getElementById('csv-has-headers').value === 'true';
            const delimiter = document.getElementById('csv-delimiter').value;
            const lines = content.split('\n');
            
            let startLine = hasHeaders ? 1 : 0;
            let validRows = 0;
            
            // Procesar cada línea
            for (let i = startLine; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Saltar líneas completamente vacías
                if (!line) continue;
                
                const values = line.split(delimiter).map(val => val.trim().replace(/"/g, ''));
                
                // Verificar que haya al menos una columna con valor numérico válido
                if (values.length >= 1 && values[0] !== '') {
                    const numericValue = parseFloat(values[0]);
                    if (!isNaN(numericValue)) {
                        data.push(numericValue);
                        validRows++;
                        
                        // Si hay segunda columna, usarla como metadatos
                        if (values.length >= 2 && values[1] !== '') {
                            metadata.push(values[1]);
                        } else {
                            metadata.push(`Obs ${validRows}`);
                        }
                    }
                }
            }
            
            // Limpiar datos existentes
            clearData();
            
            // Agregar datos importados
            if (data.length > 0) {
                const dataBody = document.getElementById('data-body');
                dataBody.innerHTML = '';
                observationCounter = 1;
                
                // Agregar cada dato como una observación
                data.forEach((value, index) => {
                    // Crear la fila
                    const newRow = document.createElement('tr');
                    
                    // Celda de número de observación
                    const obsCell = document.createElement('td');
                    obsCell.textContent = observationCounter;
                    newRow.appendChild(obsCell);
                    
                    // Celda para valor individual
                    const inputCell = document.createElement('td');
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'sample-input';
                    input.step = 'any';
                    input.value = value; // ESTABLECER EL VALOR DIRECTAMENTE
                    input.addEventListener('input', function() {
                        calculateMovingRanges();
                        updateDashboardSummary();
                    });
                    inputCell.appendChild(input);
                    newRow.appendChild(inputCell);
                    
                    // Celda para metadatos
                    const metadataCell = document.createElement('td');
                    const metadataInput = document.createElement('input');
                    metadataInput.type = 'text';
                    metadataInput.className = 'metadata-input';
                    metadataInput.placeholder = 'Fecha/Lote/Máquina...';
                    metadataInput.value = metadata[index] || ''; // ESTABLECER METADATOS DIRECTAMENTE
                    metadataInput.addEventListener('input', function() {
                        updateDashboardSummary();
                    });
                    
                    // AUMENTAR LONGITUD MÁXIMA DE CARACTERES (de 50 a 100)
                    metadataInput.maxLength = 120;
                    
                    metadataCell.appendChild(metadataInput);
                    newRow.appendChild(metadataCell);
                    
                    // Celda para rango móvil
                    const rangeCell = document.createElement('td');
                    rangeCell.className = 'moving-range';
                    rangeCell.textContent = '-';
                    newRow.appendChild(rangeCell);
                    
                    dataBody.appendChild(newRow);
                    observationCounter++;
                });
                
                // Guardar metadatos para uso en gráficos
                metadataLabels = metadata;
                
                // Recalcular rangos móviles
                calculateMovingRanges();
                
                // Actualizar resumen inmediatamente
                updateDashboardSummary();
                
                // Cerrar modal
                hideImportModal();
                
                alert(`Se importaron ${data.length} observaciones correctamente`);
            } else {
                alert('No se encontraron datos válidos en el archivo');
                // Restaurar una observación vacía
                addObservation();
            }
            
        } catch (error) {
            alert('Error al importar datos: ' + error.message);
            console.error('Error detallado:', error);
            // Restaurar una observación vacía en caso de error
            addObservation();
        }
    };
    
    reader.onerror = function() {
        alert('Error al leer el archivo');
        // Restaurar una observación vacía en caso de error
        addObservation();
    };
    
    reader.readAsText(file);
}













        
        // Mostrar modal de correo
        function showEmailModal() {
            document.getElementById('email-modal').style.display = 'flex';
        }
        
        // Ocultar modal de correo
        function hideEmailModal() {
            document.getElementById('email-modal').style.display = 'none';
        }
        
        // Enviar correo
        function sendEmail() {
            const to = document.getElementById('email-to').value;
            const subject = document.getElementById('email-subject').value;
            const message = document.getElementById('email-message').value;
            
            if (!to) {
                alert('Por favor, ingrese un destinatario');
                return;
            }
            
            // Crear contenido del correo
            const processName = document.getElementById('process-name').value || 'Proceso Sin Nombre';
            const now = new Date();
            
            let emailBody = `
Reporte Ejecutivo - Carta de Control I-RM

Proceso: ${processName}
Fecha de generación: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}

RESUMEN EJECUTIVO
-----------------
Estado del proceso: ${document.getElementById('process-status-value').textContent}
Capacidad del proceso (Cpk): ${document.getElementById('cpk-summary').textContent}
Observaciones analizadas: ${document.getElementById('observations-count').textContent}
Puntos fuera de control: ${document.getElementById('out-of-control-count').textContent}
Puntos fuera de especificación: ${document.getElementById('out-of-spec-count').textContent}
Modo de límites: ${document.getElementById('limits-mode-info').textContent}

ESTADÍSTICAS DEL PROCESO
------------------------
Media de rangos móviles (R̄): ${document.getElementById('mr-bar').textContent}
Media del proceso (μ̂): ${document.getElementById('process-mean').textContent}
Desviación estándar (σ̂): ${document.getElementById('process-std').textContent}
Registros para límites: ${document.getElementById('limits-base-count').textContent}

LÍMITES DE CONTROL
------------------
Carta I (Individual):
- Línea Central (CL): ${document.getElementById('i-cl').textContent}
- Límite Superior (UCL): ${document.getElementById('i-ucl').textContent}
- Límite Inferior (LCL): ${document.getElementById('i-lcl').textContent}
- Base: ${document.getElementById('i-limits-base').textContent}

Carta RM (Rango Móvil):
- Línea Central (CL): ${document.getElementById('rm-cl').textContent}
- Límite Superior (UCL): ${document.getElementById('rm-ucl').textContent}
- Límite Inferior (LCL): ${document.getElementById('rm-lcl').textContent}
- Base: ${document.getElementById('rm-limits-base').textContent}

LÍMITES DE ESPECIFICACIÓN
-------------------------
Límite Superior (USL): ${document.getElementById('i-usl').textContent}
Límite Inferior (LSL): ${document.getElementById('i-lsl').textContent}

CAPACIDAD DEL PROCESO
---------------------
Cₚ: ${document.getElementById('cp-value').textContent}
Cₚₖ: ${document.getElementById('cpk-value').textContent}
Rendimiento: ${document.getElementById('yield-percent').textContent}%

INTERPRETACIÓN
--------------
${document.getElementById('capability-interpretation').textContent.replace('Interpretación:', '').trim()}

RECOMENDACIONES
---------------
${document.getElementById('recommendations').textContent}
            `;
            
            if (message) {
                emailBody += `\n\nMENSAJE ADICIONAL:\n${message}`;
            }
            
            emailBody += `\n\n---\nEste reporte fue generado automáticamente por el sistema de Control de Calidad.`;
            
            // Crear enlace de correo
            const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            // Abrir cliente de correo
            window.location.href = mailtoLink;
            
            hideEmailModal();
        }
        
        // Exportar a PDF
        function exportToPDF() {
            // Verificar si jsPDF está disponible
            if (typeof jspdf === 'undefined') {
                alert('Error: La biblioteca jsPDF no está cargada correctamente');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const processName = document.getElementById('process-name').value || 'Proceso Sin Nombre';
            const now = new Date();
            
            // Título del reporte
            doc.setFontSize(20);
            doc.text('REPORTE EJECUTIVO - CARTA DE CONTROL I-RM', 105, 20, { align: 'center' });
            
            // Información del proceso
            doc.setFontSize(12);
            doc.text(`Proceso: ${processName}`, 20, 40);
            doc.text(`Fecha de generación: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, 20, 50);
            doc.text(`Observaciones analizadas: ${document.getElementById('observations-count').textContent}`, 20, 60);
            doc.text(`Modo de límites: ${document.getElementById('limits-mode-info').textContent}`, 20, 70);
            
            // Estado del proceso
            doc.setFontSize(14);
            doc.text('RESUMEN EJECUTIVO', 20, 90);
            doc.setFontSize(12);
            doc.text(`Estado del proceso: ${document.getElementById('process-status-value').textContent}`, 20, 105);
            doc.text(`Capacidad del proceso (Cpk): ${document.getElementById('cpk-summary').textContent}`, 20, 115);
            doc.text(`Puntos fuera de control: ${document.getElementById('out-of-control-count').textContent}`, 20, 125);
            doc.text(`Puntos fuera de especificación: ${document.getElementById('out-of-spec-count').textContent}`, 20, 135);
            
            // Interpretación de capacidad
            const interpretationText = document.getElementById('capability-interpretation').textContent.replace('Interpretación:', '').trim();
            if (interpretationText) {
                doc.text('Interpretación de capacidad:', 20, 150);
                const splitText = doc.splitTextToSize(interpretationText, 170);
                doc.text(splitText, 20, 160);
            }
            
            // Recomendaciones
            doc.text('Recomendaciones:', 20, 180);
            const recommendationsText = document.getElementById('recommendations').textContent;
            const splitRecommendations = doc.splitTextToSize(recommendationsText, 170);
            doc.text(splitRecommendations, 20, 190);
            
            // Estadísticas del proceso
            doc.addPage();
            doc.setFontSize(16);
            doc.text('ESTADÍSTICAS DEL PROCESO', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            
            const stats = [
                `Media de rangos móviles (R̄): ${document.getElementById('mr-bar').textContent}`,
                `Media del proceso (μ̂): ${document.getElementById('process-mean').textContent}`,
                `Desviación estándar (σ̂): ${document.getElementById('process-std').textContent}`,
                `Registros para límites: ${document.getElementById('limits-base-count').textContent}`
            ];
            
            stats.forEach((stat, index) => {
                doc.text(stat, 20, 40 + index * 10);
            });
            
            // Límites de control
            doc.text('Límites de Control para I (Individual):', 20, 85);
            doc.text(`Línea Central (CL): ${document.getElementById('i-cl').textContent}`, 30, 95);
            doc.text(`Límite Superior (UCL): ${document.getElementById('i-ucl').textContent}`, 30, 105);
            doc.text(`Límite Inferior (LCL): ${document.getElementById('i-lcl').textContent}`, 30, 115);
            doc.text(`Base: ${document.getElementById('i-limits-base').textContent}`, 30, 125);
            
            // Límites de especificación
            doc.text('Límites de Especificación:', 20, 140);
            doc.text(`Límite Superior (USL): ${document.getElementById('i-usl').textContent}`, 30, 150);
            doc.text(`Límite Inferior (LSL): ${document.getElementById('i-lsl').textContent}`, 30, 160);
            
            doc.text('Límites de Control para RM (Rango Móvil):', 20, 175);
            doc.text(`Línea Central (CL): ${document.getElementById('rm-cl').textContent}`, 30, 185);
            doc.text(`Límite Superior (UCL): ${document.getElementById('rm-ucl').textContent}`, 30, 195);
            doc.text(`Límite Inferior (LCL): ${document.getElementById('rm-lcl').textContent}`, 30, 205);
            doc.text(`Base: ${document.getElementById('rm-limits-base').textContent}`, 30, 215);
            
            // Capacidad del proceso
            if (document.getElementById('cp-value').textContent !== '-') {
                doc.text('Capacidad del Proceso:', 20, 230);
                doc.text(`Cₚ: ${document.getElementById('cp-value').textContent}`, 30, 240);
                doc.text(`Cₚₖ: ${document.getElementById('cpk-value').textContent}`, 30, 250);
                doc.text(`Rendimiento: ${document.getElementById('yield-percent').textContent}%`, 30, 260);
            }
            
            // Guardar PDF
            doc.save(`Reporte_Ejecutivo_${processName.replace(/\s+/g, '_')}_${now.getTime()}.pdf`);
        }
        
        // Actualizar estado de especificaciones
        function updateSpecStatus() {
            const usl = document.getElementById('usl').value;
            const lsl = document.getElementById('lsl').value;
            const uslStatus = document.getElementById('usl-status');
            const lslStatus = document.getElementById('lsl-status');
            
            if (usl) {
                uslStatus.textContent = 'USL configurado';
                uslStatus.className = 'spec-status spec-applied';
            } else {
                uslStatus.textContent = 'USL no configurado';
                uslStatus.className = 'spec-status spec-missing';
            }
            
            if (lsl) {
                lslStatus.textContent = 'LSL configurado';
                lslStatus.className = 'spec-status spec-applied';
            } else {
                lslStatus.textContent = 'LSL no configurado';
                lslStatus.className = 'spec-status spec-missing';
            }
        }
        
        // Actualizar resumen del dashboard
        function updateDashboardSummary() {
            const observations = [];
            const rows = document.querySelectorAll('#data-body tr');
            
            rows.forEach(row => {
                const input = row.querySelector('.sample-input');
                if (input.value && !isNaN(parseFloat(input.value))) {
                    observations.push(parseFloat(input.value));
                }
            });
            
            // Actualizar contadores
            document.getElementById('observations-count').textContent = observations.length;
            
            // Calcular rangos móviles válidos
            const validRanges = [];
            for (let i = 1; i < rows.length; i++) {
                const rangeCell = rows[i].querySelector('.moving-range');
                if (rangeCell.textContent !== '-') {
                    validRanges.push(parseFloat(rangeCell.textContent));
                }
            }
            document.getElementById('ranges-count').textContent = validRanges.length;
            
            // Actualizar estado del proceso
            const processStatusValue = document.getElementById('process-status-value');
            const processStatusLabel = document.getElementById('process-status-label');
            
            if (observations.length < 2) {
                processStatusValue.textContent = 'Sin datos';
                processStatusLabel.textContent = 'Ingrese al menos 2 observaciones';
            } else {
                processStatusValue.textContent = 'Datos suficientes';
                processStatusLabel.textContent = 'Puede calcular la carta de control';
            }
            
            // Actualizar Cpk si está disponible
            const cpkElement = document.getElementById('cpk-value');
            if (cpkElement.textContent !== '-') {
                const cpk = parseFloat(cpkElement.textContent);
                document.getElementById('cpk-summary').textContent = cpk.toFixed(2);
                document.getElementById('cpk-status').textContent = getCpkStatusText(cpk);
            }
        }
    </script>
</body>
</html>
