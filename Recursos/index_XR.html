<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carta de Control X̄-R - Con Límites de Especificación</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-gray: #f5f5f5;
            --border-color: #ddd;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: var(--light-gray);
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .card h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.secondary {
            background-color: #95a5a6;
        }
        
        button.secondary:hover {
            background-color: #7f8c8d;
        }
        
        button.success {
            background-color: var(--success-color);
        }
        
        button.success:hover {
            background-color: #219653;
        }
        
        button.warning {
            background-color: var(--warning-color);
        }
        
        button.warning:hover {
            background-color: #e67e22;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 8px 10px;
            text-align: center;
        }
        
        th {
            background-color: var(--light-gray);
            font-weight: 600;
        }
        
        .sample-input {
            width: 60px;
            padding: 4px;
            text-align: center;
        }
        
        .chart-container {
            margin: 30px 0;
            height: 300px;
            position: relative;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .formula-explanation {
            margin-top: 30px;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 5px;
        }
        
        .formula-explanation h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .formula-item {
            margin-bottom: 15px;
        }
        
        .formula-item h4 {
            margin-bottom: 5px;
            color: var(--secondary-color);
        }
        
        .copyright {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: #777;
            font-size: 0.9rem;
        }
        
        .error {
            color: var(--accent-color);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .success {
            color: var(--success-color);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .warning {
            color: var(--warning-color);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .data-section {
            overflow-x: auto;
        }
        
        .sample-header {
            background-color: #e8f4f8;
            font-weight: bold;
        }
        
        .capability-interpretation {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
            border-left: 4px solid var(--secondary-color);
        }
        
        .capability-good {
            border-left-color: var(--success-color);
            background-color: #e8f5e8;
        }
        
        .capability-warning {
            border-left-color: var(--warning-color);
            background-color: #fef9e7;
        }
        
        .capability-poor {
            border-left-color: var(--accent-color);
            background-color: #fdeaea;
        }
        
        .interpretation-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .process-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-excellent {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-acceptable {
            background-color: #2ecc71;
            color: white;
        }
        
        .status-marginal {
            background-color: var(--warning-color);
            color: white;
        }
        
        .status-poor {
            background-color: var(--accent-color);
            color: white;
        }
        
        .spec-status {
            font-size: 0.8rem;
            margin-top: 5px;
            font-style: italic;
        }
        
        .spec-applied {
            color: var(--success-color);
        }
        
        .spec-missing {
            color: var(--warning-color);
        }
        
        .export-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .export-section h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .export-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .modal h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .file-input-container {
            margin-bottom: 15px;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .file-input-label:hover {
            background-color: #2980b9;
        }
        
        .file-input {
            display: none;
        }
        
        .file-info {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Nuevos estilos para mejoras */
        .parameter-explanation {
            background-color: #e8f4f8;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .parameter-title {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid var(--secondary-color);
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .summary-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .control-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
        
        .in-control {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        
        .out-of-control-status {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }
        
        .data-table-container {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }
        
        .sticky-header th {
            position: sticky;
            top: 0;
            background-color: var(--light-gray);
            z-index: 10;
        }
        
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Carta de Control X̄-R - Con Límites de Especificación</h1>
            <p>Herramienta para monitoreo y control de procesos estadísticos</p>
        </header>
        
        <!-- Panel de Resumen -->
        <div class="dashboard-summary" id="dashboard-summary">
            <div class="summary-card">
                <div class="summary-label">Estado del Proceso</div>
                <div class="summary-value" id="process-status-value">-</div>
                <div class="summary-label" id="process-status-label">Sin datos</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Capacidad (Cpk)</div>
                <div class="summary-value" id="cpk-summary">-</div>
                <div class="summary-label" id="cpk-status">No calculado</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Días</div>
                <div class="summary-value" id="samples-count">0</div>
                <div class="summary-label">Total registrados</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Observaciones</div>
                <div class="summary-value" id="observations-count">0</div>
                <div class="summary-label">Total mediciones</div>
            </div>
        </div>
        
        <div class="input-section">
            <div class="card">
                <h2>Configuración del Proceso</h2>
                
                <div class="parameter-explanation">
                    <div class="parameter-title">n (Tamaño de muestra)</div>
                    <p>Número de observaciones en cada día. Ejemplo: Si mide 5 piezas cada día, n=5.</p>
                </div>
                
                <div class="form-group">
                    <label for="sample-size">Tamaño de Muestra (n):</label>
                    <input type="number" id="sample-size" value="5" min="2" max="10">
                </div>
                
                <div class="parameter-explanation">
                    <div class="parameter-title">k (Límites de control)</div>
                    <p>Define el ancho de los límites de control. k=3 significa límites a ±3 desviaciones estándar (99.73% de datos).</p>
                </div>
                
                <div class="form-group">
                    <label for="k-value">Valor k (para límites de control):</label>
                    <input type="number" id="k-value" value="3" step="0.1" min="1" max="5">
                </div>
                
                <div class="form-group">
                    <label for="process-name">Nombre del Proceso:</label>
                    <input type="text" id="process-name" placeholder="Ej: Espesor promedio (mm)">
                </div>
                
                <div class="form-group">
                    <label for="usl">Límite Superior de Especificación (USL):</label>
                    <input type="number" id="usl" placeholder="Opcional">
                    <div id="usl-status" class="spec-status"></div>
                </div>
                <div class="form-group">
                    <label for="lsl">Límite Inferior de Especificación (LSL):</label>
                    <input type="number" id="lsl" placeholder="Opcional">
                    <div id="lsl-status" class="spec-status"></div>
                </div>
                <div class="form-group">
                    <button id="apply-sample-size">Aplicar Tamaño de Muestra</button>
                    <button id="add-sample-btn" class="secondary">Agregar Día</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Instrucciones</h2>
                <p>1. Configure el tamaño de muestra (n) y haga clic en "Aplicar Tamaño de Muestra".</p>
                <p>2. Ingrese los datos individuales de cada observación en la tabla.</p>
                <p>3. La media (X̄) y rango (R) se calcularán automáticamente.</p>
                <p>4. Haga clic en "Calcular Carta de Control" para generar los gráficos.</p>
                <p>5. Los límites USL y LSL se mostrarán como líneas rojas en el gráfico X̄.</p>
                <button id="calculate-btn">Calcular Carta de Control</button>
                <button id="clear-data" class="secondary">Limpiar Datos</button>
                <button id="import-data-btn" class="warning">Importar desde CSV/Excel</button>
            </div>
        </div>
        
        <div class="card">
            <h2>Datos por Día</h2>
            <div class="data-section">
                <div class="data-table-container">
                    <table id="data-table">
                        <thead>
                            <tr id="table-header" class="sticky-header">
                                <!-- Los encabezados se generarán dinámicamente -->
                            </tr>
                        </thead>
                        <tbody id="data-body">
                            <!-- Las filas de datos se agregarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Estado de Control del Proceso -->
        <div class="card">
            <h2>Estado del Control del Proceso</h2>
            <div id="control-status" class="control-status">
                Estado del proceso: Sin datos suficientes para evaluación
            </div>
            <div id="control-analysis" style="margin-top: 15px;">
                <p>Puntos fuera de control: <span id="out-of-control-count">0</span></p>
                <p>Puntos fuera de especificación: <span id="out-of-spec-count">0</span></p>
                <p>Recomendaciones: <span id="recommendations">Ingrese más datos para obtener recomendaciones</span></p>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="card">
                <h2>Estadísticas del Proceso</h2>
                <div id="process-stats">
                    <p>Rango promedio (R̄): <span id="r-bar">-</span></p>
                    <p>Media del proceso (μ̂): <span id="process-mean">-</span></p>
                    <p>Desviación estándar (σ̂): <span id="process-std">-</span></p>
                    <p>Error estándar (σ<sub>X̄</sub>): <span id="std-error">-</span></p>
                </div>
            </div>
            
            <div class="card">
                <h2>Capacidad del Proceso</h2>
                <div id="process-capability">
                    <p>C<sub>p</sub>: <span id="cp-value">-</span></p>
                    <p>C<sub>pk</sub>: <span id="cpk-value">-</span></p>
                    <p>Rendimiento (%): <span id="yield-percent">-</span></p>
                    <div id="capability-interpretation">
                        <!-- La interpretación se generará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Carta de Control X̄ (Media) con Límites de Especificación</h2>
            <div class="chart-container">
                <canvas id="xbar-chart"></canvas>
            </div>
            <div class="chart-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(54, 162, 235);"></div>
                    <span>Media (X̄)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(0, 0, 0); border: 1px dashed #000;"></div>
                    <span>Línea Central (CL)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(220, 53, 69); border: 1px dashed #dc3545;"></div>
                    <span>Límites de Control (UCL/LCL)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(255, 0, 0);"></div>
                    <span>Límites de Especificación (USL/LSL)</span>
                </div>
            </div>
            <div id="xbar-limits">
                <p>Línea Central (CL): <span id="xbar-cl">-</span></p>
                <p>Límite Superior de Control (UCL): <span id="xbar-ucl">-</span></p>
                <p>Límite Inferior de Control (LCL): <span id="xbar-lcl">-</span></p>
                <p>Límite Superior de Especificación (USL): <span id="xbar-usl">-</span></p>
                <p>Límite Inferior de Especificación (LSL): <span id="xbar-lsl">-</span></p>
            </div>
        </div>
        
        <div class="card">
            <h2>Carta de Control R (Rango)</h2>
            <div class="chart-container">
                <canvas id="r-chart"></canvas>
            </div>
            <div class="chart-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(255, 159, 64);"></div>
                    <span>Rango (R)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(0, 0, 0); border: 1px dashed #000;"></div>
                    <span>Línea Central (CL)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgb(220, 53, 69); border: 1px dashed #dc3545;"></div>
                    <span>Límites de Control (UCL/LCL)</span>
                </div>
            </div>
            <div id="r-limits">
                <p>Línea Central (CL): <span id="r-cl">-</span></p>
                <p>Límite Superior de Control (UCL): <span id="r-ucl">-</span></p>
                <p>Límite Inferior de Control (LCL): <span id="r-lcl">-</span></p>
            </div>
        </div>
        
        <div class="export-section">
            <h3>Exportar Reporte Ejecutivo</h3>
            <div class="export-buttons">
                <button id="export-pdf-btn" class="success">Generar PDF Ejecutivo</button>
                <button id="send-email-btn" class="warning">Enviar por Correo</button>
            </div>
        </div>
        
        <div class="copyright">
            <p>© 2023 Carta de Control X̄-R - Con Límites de Especificación</p>
        </div>
    </div>

    <!-- Modal para importación de datos -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <h3>Importar Datos desde Archivo</h3>
            <div class="file-input-container">
                <label for="file-input" class="file-input-label">Seleccionar archivo CSV o Excel</label>
                <input type="file" id="file-input" class="file-input" accept=".csv,.xlsx,.xls">
                <div class="file-info" id="file-info">No se ha seleccionado ningún archivo</div>
            </div>
            <div class="form-group">
                <label for="csv-delimiter">Separador (para archivos CSV):</label>
                <select id="csv-delimiter">
                    <option value=",">Coma (,)</option>
                    <option value=";">Punto y coma (;)</option>
                    <option value="\t">Tabulador</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button id="cancel-import" class="secondary">Cancelar</button>
                <button id="confirm-import" class="success">Importar</button>
            </div>
        </div>
    </div>

    <!-- Modal para envío por correo -->
    <div id="email-modal" class="modal">
        <div class="modal-content">
            <h3>Enviar Reporte Ejecutivo por Correo</h3>
            <div class="form-group">
                <label for="email-to">Destinatario:</label>
                <input type="email" id="email-to" value="jtxdossier@gmail.com">
            </div>
            <div class="form-group">
                <label for="email-subject">Asunto:</label>
                <input type="text" id="email-subject" value="Reporte Ejecutivo - Carta de Control X̄-R">
            </div>
            <div class="form-group">
                <label for="email-message">Mensaje:</label>
                <textarea id="email-message" rows="4" placeholder="Mensaje opcional..."></textarea>
            </div>
            <div class="modal-buttons">
                <button id="cancel-email" class="secondary">Cancelar</button>
                <button id="send-email" class="success">Enviar Reporte</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Constantes para factores d2 y d3 según tamaño de muestra
        const d2Values = {
            2: 1.128,
            3: 1.693,
            4: 2.059,
            5: 2.326,
            6: 2.534,
            7: 2.704,
            8: 2.847,
            9: 2.970,
            10: 3.078
        };
        
        const d3Values = {
            2: 0.853,
            3: 0.888,
            4: 0.880,
            5: 0.864,
            6: 0.848,
            7: 0.833,
            8: 0.820,
            9: 0.808,
            10: 0.797
        };
        
        // Variables globales
        let sampleCounter = 1;
        let sampleSize = 5;
        let xbarChart, rChart;
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Aplicar tamaño de muestra inicial
            applySampleSize();
            
            // Agregar muestra inicial
            addSample();
            
            // Configurar eventos
            document.getElementById('apply-sample-size').addEventListener('click', applySampleSize);
            document.getElementById('add-sample-btn').addEventListener('click', addSample);
            document.getElementById('calculate-btn').addEventListener('click', calculateControlChart);
            document.getElementById('clear-data').addEventListener('click', clearData);
            document.getElementById('import-data-btn').addEventListener('click', showImportModal);
            document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
            document.getElementById('send-email-btn').addEventListener('click', showEmailModal);
            
            // Eventos para modales
            document.getElementById('cancel-import').addEventListener('click', hideImportModal);
            document.getElementById('confirm-import').addEventListener('click', importDataFromFile);
            document.getElementById('file-input').addEventListener('change', updateFileInfo);
            document.getElementById('cancel-email').addEventListener('click', hideEmailModal);
            document.getElementById('send-email').addEventListener('click', sendEmail);
            
            // Monitorear cambios en los límites de especificación
            document.getElementById('usl').addEventListener('input', updateSpecStatus);
            document.getElementById('lsl').addEventListener('input', updateSpecStatus);
            
            // Inicializar gráficos
            initializeCharts();
            
            // Actualizar estado inicial de especificaciones
            updateSpecStatus();
            
            // Actualizar resumen inicial
            updateDashboardSummary();
        });
        
        // Aplicar tamaño de muestra
        function applySampleSize() {
            const newSampleSize = parseInt(document.getElementById('sample-size').value);
            
            if (newSampleSize >= 2 && newSampleSize <= 10) {
                sampleSize = newSampleSize;
                rebuildTableHeader();
                updateDashboardSummary();
            } else {
                alert('El tamaño de muestra debe estar entre 2 y 10');
                document.getElementById('sample-size').value = sampleSize;
            }
        }
        
        // Reconstruir encabezado de tabla
        function rebuildTableHeader() {
            const tableHeader = document.getElementById('table-header');
            tableHeader.innerHTML = '';
            
            // Agregar columna de día
            const sampleHeader = document.createElement('th');
            sampleHeader.textContent = 'Día';
            tableHeader.appendChild(sampleHeader);
            
            // Agregar columnas para observaciones
            for (let i = 1; i <= sampleSize; i++) {
                const obsHeader = document.createElement('th');
                obsHeader.textContent = `X${i}`;
                tableHeader.appendChild(obsHeader);
            }
            
            // Agregar columnas para estadísticas
            const meanHeader = document.createElement('th');
            meanHeader.textContent = 'X̄';
            tableHeader.appendChild(meanHeader);
            
            const rangeHeader = document.createElement('th');
            rangeHeader.textContent = 'R';
            tableHeader.appendChild(rangeHeader);
        }
        
        // Agregar nuevo día
        function addSample() {
            const dataBody = document.getElementById('data-body');
            const newRow = document.createElement('tr');
            
            // Celda de número de día
            const sampleCell = document.createElement('td');
            sampleCell.textContent = sampleCounter;
            newRow.appendChild(sampleCell);
            
            // Celdas para observaciones
            for (let i = 0; i < sampleSize; i++) {
                const inputCell = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'sample-input';
                input.addEventListener('input', function() {
                    calculateSampleStats(newRow);
                    updateDashboardSummary();
                });
                inputCell.appendChild(input);
                newRow.appendChild(inputCell);
            }
            
            // Celdas para estadísticas
            const meanCell = document.createElement('td');
            meanCell.className = 'sample-mean';
            meanCell.textContent = '-';
            newRow.appendChild(meanCell);
            
            const rangeCell = document.createElement('td');
            rangeCell.className = 'sample-range';
            rangeCell.textContent = '-';
            newRow.appendChild(rangeCell);
            
            dataBody.appendChild(newRow);
            sampleCounter++;
            
            updateDashboardSummary();
        }
        
        // Calcular estadísticas para una muestra
        function calculateSampleStats(row) {
            const inputs = row.querySelectorAll('.sample-input');
            const values = [];
            
            // Recopilar valores válidos
            inputs.forEach(input => {
                const value = parseFloat(input.value);
                if (!isNaN(value)) {
                    values.push(value);
                }
            });
            
            // Calcular estadísticas si hay suficientes valores
            if (values.length > 0) {
                const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
                const range = Math.max(...values) - Math.min(...values);
                
                row.querySelector('.sample-mean').textContent = mean.toFixed(4);
                row.querySelector('.sample-range').textContent = range.toFixed(4);
            } else {
                row.querySelector('.sample-mean').textContent = '-';
                row.querySelector('.sample-range').textContent = '-';
            }
        }
        
        // Calcular carta de control
        function calculateControlChart() {
            const sampleMeans = [];
            const sampleRanges = [];
            const sampleNumbers = [];
            
            // Recopilar datos de todas las muestras
            const rows = document.querySelectorAll('#data-body tr');
            
            rows.forEach(row => {
                const meanCell = row.querySelector('.sample-mean');
                const rangeCell = row.querySelector('.sample-range');
                
                if (meanCell.textContent !== '-' && rangeCell.textContent !== '-') {
                    sampleMeans.push(parseFloat(meanCell.textContent));
                    sampleRanges.push(parseFloat(rangeCell.textContent));
                    sampleNumbers.push(parseInt(row.cells[0].textContent));
                }
            });
            
            // Verificar si hay datos suficientes
            if (sampleMeans.length < 2) {
                alert('Se necesitan al menos 2 días con datos para calcular la carta de control');
                return;
            }
            
            // Calcular estadísticas del proceso
            const rBar = sampleRanges.reduce((sum, r) => sum + r, 0) / sampleRanges.length;
            const processMean = sampleMeans.reduce((sum, mean) => sum + mean, 0) / sampleMeans.length;
            
            // Obtener factores d2 y d3
            const d2 = d2Values[sampleSize];
            const d3 = d3Values[sampleSize];
            
            // Calcular desviación estándar
            const processStd = rBar / d2;
            const stdError = processStd / Math.sqrt(sampleSize);
            
            // Obtener valor k
            const k = parseFloat(document.getElementById('k-value').value);
            
            // Calcular límites de control para X̄
            const xbarUCL = processMean + k * stdError;
            const xbarLCL = processMean - k * stdError;
            
            // Calcular límites de control para R
            const rUCL = rBar * (1 + k * (d3 / d2));
            const rLCL = Math.max(0, rBar * (1 - k * (d3 / d2)));
            
            // Obtener límites de especificación
            const usl = document.getElementById('usl').value ? parseFloat(document.getElementById('usl').value) : null;
            const lsl = document.getElementById('lsl').value ? parseFloat(document.getElementById('lsl').value) : null;
            
            // Detectar puntos fuera de control y fuera de especificación
            let outOfControlCount = 0;
            let outOfSpecCount = 0;
            
            sampleMeans.forEach(mean => {
                if (mean > xbarUCL || mean < xbarLCL) {
                    outOfControlCount++;
                }
                if (usl !== null && mean > usl) {
                    outOfSpecCount++;
                }
                if (lsl !== null && mean < lsl) {
                    outOfSpecCount++;
                }
            });
            
            sampleRanges.forEach(range => {
                if (range > rUCL || (rLCL > 0 && range < rLCL)) {
                    outOfControlCount++;
                }
            });
            
            // Actualizar estadísticas en la interfaz
            document.getElementById('r-bar').textContent = rBar.toFixed(4);
            document.getElementById('process-mean').textContent = processMean.toFixed(4);
            document.getElementById('process-std').textContent = processStd.toFixed(4);
            document.getElementById('std-error').textContent = stdError.toFixed(4);
            
            document.getElementById('xbar-cl').textContent = processMean.toFixed(4);
            document.getElementById('xbar-ucl').textContent = xbarUCL.toFixed(4);
            document.getElementById('xbar-lcl').textContent = xbarLCL.toFixed(4);
            document.getElementById('xbar-usl').textContent = usl !== null ? usl.toFixed(4) : '-';
            document.getElementById('xbar-lsl').textContent = lsl !== null ? lsl.toFixed(4) : '-';
            
            document.getElementById('r-cl').textContent = rBar.toFixed(4);
            document.getElementById('r-ucl').textContent = rUCL.toFixed(4);
            document.getElementById('r-lcl').textContent = rLCL > 0 ? rLCL.toFixed(4) : '0';
            
            // Actualizar estado de control
            updateControlStatus(outOfControlCount, outOfSpecCount);
            
            // Calcular capacidad del proceso si hay especificaciones
            calculateProcessCapability(processMean, processStd);
            
            // Actualizar gráficos
            updateCharts(sampleNumbers, sampleMeans, sampleRanges, processMean, xbarUCL, xbarLCL, rBar, rUCL, rLCL, usl, lsl);
            
            // Actualizar resumen del dashboard
            updateDashboardSummary();
        }
        
        // Actualizar estado de control
        function updateControlStatus(outOfControlCount, outOfSpecCount) {
            const controlStatus = document.getElementById('control-status');
            const recommendations = document.getElementById('recommendations');
            
            document.getElementById('out-of-control-count').textContent = outOfControlCount;
            document.getElementById('out-of-spec-count').textContent = outOfSpecCount;
            
            if (outOfControlCount === 0 && outOfSpecCount === 0) {
                controlStatus.textContent = '✅ Proceso bajo control estadístico y dentro de especificaciones';
                controlStatus.className = 'control-status in-control';
                recommendations.textContent = 'Continúe con el monitoreo regular del proceso';
            } else if (outOfControlCount > 0 && outOfSpecCount === 0) {
                controlStatus.textContent = `⚠️ Proceso fuera de control - ${outOfControlCount} punto(s) fuera de límites de control`;
                controlStatus.className = 'control-status out-of-control-status';
                recommendations.textContent = 'Investigue las causas especiales de variación e implemente acciones correctivas';
            } else if (outOfSpecCount > 0) {
                controlStatus.textContent = `❌ Proceso fuera de especificación - ${outOfSpecCount} punto(s) fuera de límites de especificación`;
                controlStatus.className = 'control-status out-of-control-status';
                recommendations.textContent = 'El proceso no cumple con los requisitos del cliente. Revise el proceso inmediatamente.';
            }
        }
        
        // Actualizar resumen del dashboard
        function updateDashboardSummary() {
            const rows = document.querySelectorAll('#data-body tr');
            let validSamples = 0;
            let totalObservations = 0;
            
            rows.forEach(row => {
                const meanCell = row.querySelector('.sample-mean');
                if (meanCell.textContent !== '-') {
                    validSamples++;
                    // Contar observaciones válidas en esta muestra
                    const inputs = row.querySelectorAll('.sample-input');
                    inputs.forEach(input => {
                        if (input.value && !isNaN(parseFloat(input.value))) {
                            totalObservations++;
                        }
                    });
                }
            });
            
            document.getElementById('samples-count').textContent = validSamples;
            document.getElementById('observations-count').textContent = totalObservations;
            
            // Actualizar estado del proceso basado en Cpk si está disponible
            const cpkValue = document.getElementById('cpk-value').textContent;
            const processStatusValue = document.getElementById('process-status-value');
            const processStatusLabel = document.getElementById('process-status-label');
            const cpkSummary = document.getElementById('cpk-summary');
            const cpkStatus = document.getElementById('cpk-status');
            
            if (cpkValue !== '-') {
                const cpk = parseFloat(cpkValue);
                cpkSummary.textContent = cpk.toFixed(2);
                
                if (cpk >= 1.67) {
                    processStatusValue.textContent = 'Excelente';
                    processStatusValue.style.color = 'var(--success-color)';
                    processStatusLabel.textContent = 'Clase Mundial';
                    cpkStatus.textContent = 'Excelente';
                } else if (cpk >= 1.33) {
                    processStatusValue.textContent = 'Adecuado';
                    processStatusValue.style.color = '#2ecc71';
                    processStatusLabel.textContent = 'Aceptable';
                    cpkStatus.textContent = 'Adecuado';
                } else if (cpk >= 1.00) {
                    processStatusValue.textContent = 'Marginal';
                    processStatusValue.style.color = 'var(--warning-color)';
                    processStatusLabel.textContent = 'Requiere monitoreo';
                    cpkStatus.textContent = 'Marginal';
                } else {
                    processStatusValue.textContent = 'Inadecuado';
                    processStatusValue.style.color = 'var(--accent-color)';
                    processStatusLabel.textContent = 'Requiere mejora';
                    cpkStatus.textContent = 'Inadecuado';
                }
            } else {
                if (validSamples > 0) {
                    processStatusValue.textContent = 'Calculando...';
                    processStatusLabel.textContent = 'Calcule la carta de control';
                } else {
                    processStatusValue.textContent = 'Sin datos';
                    processStatusLabel.textContent = 'Ingrese datos';
                }
                processStatusValue.style.color = '#666';
                cpkSummary.textContent = '-';
                cpkStatus.textContent = 'No calculado';
            }
        }
        
        // Calcular capacidad del proceso
        function calculateProcessCapability(processMean, processStd) {
            const uslInput = document.getElementById('usl');
            const lslInput = document.getElementById('lsl');
            const usl = uslInput.value ? parseFloat(uslInput.value) : null;
            const lsl = lslInput.value ? parseFloat(lslInput.value) : null;
            
            let cp = '-';
            let cpk = '-';
            let yieldPercent = '-';
            let interpretation = '';
            let interpretationClass = '';
            
            if (usl !== null && lsl !== null) {
                // Calcular Cp
                cp = (usl - lsl) / (6 * processStd);
                
                // Calcular Cpk
                const cpu = (usl - processMean) / (3 * processStd);
                const cpl = (processMean - lsl) / (3 * processStd);
                cpk = Math.min(cpu, cpl);
                
                // Calcular rendimiento (aproximación)
                const zUpper = (usl - processMean) / processStd;
                const zLower = (processMean - lsl) / processStd;
                
                // Usar función de distribución normal acumulativa aproximada
                const pUpper = 1 - (1 / (1 + Math.exp(-0.07056 * Math.pow(zUpper, 3) - 1.5976 * zUpper)));
                const pLower = 1 / (1 + Math.exp(-0.07056 * Math.pow(zLower, 3) - 1.5976 * zLower));
                
                yieldPercent = ((pUpper - (1 - pLower)) * 100).toFixed(2);
                
                // Interpretar Cpk
                if (cpk >= 1.67) {
                    interpretation = 'Proceso excelente (Clase Mundial)';
                    interpretationClass = 'capability-good status-excellent';
                } else if (cpk >= 1.33) {
                    interpretation = 'Proceso adecuado (Aceptable)';
                    interpretationClass = 'capability-good status-acceptable';
                } else if (cpk >= 1.00) {
                    interpretation = 'Proceso marginal (Requiere monitoreo)';
                    interpretationClass = 'capability-warning status-marginal';
                } else if (cpk >= 0) {
                    interpretation = 'Proceso inadecuado (Requiere mejora)';
                    interpretationClass = 'capability-poor status-poor';
                } else {
                    interpretation = 'La media del proceso está fuera de especificaciones';
                    interpretationClass = 'capability-poor status-poor';
                }
                
                document.getElementById('cp-value').textContent = cp.toFixed(4);
                document.getElementById('cpk-value').textContent = cpk.toFixed(4);
                document.getElementById('yield-percent').textContent = yieldPercent;
            } else if (usl !== null || lsl !== null) {
                // Solo un límite especificado, calcular Cpk
                if (usl !== null) {
                    cpk = (usl - processMean) / (3 * processStd);
                } else {
                    cpk = (processMean - lsl) / (3 * processStd);
                }
                
                document.getElementById('cp-value').textContent = '-';
                document.getElementById('cpk-value').textContent = cpk.toFixed(4);
                document.getElementById('yield-percent').textContent = '-';
                
                // Interpretar Cpk
                if (cpk >= 1.67) {
                    interpretation = 'Proceso excelente (Clase Mundial)';
                    interpretationClass = 'capability-good status-excellent';
                } else if (cpk >= 1.33) {
                    interpretation = 'Proceso adecuado (Aceptable)';
                    interpretationClass = 'capability-good status-acceptable';
                } else if (cpk >= 1.00) {
                    interpretation = 'Proceso marginal (Requiere monitoreo)';
                    interpretationClass = 'capability-warning status-marginal';
                } else if (cpk >= 0) {
                    interpretation = 'Proceso inadecuado (Requiere mejora)';
                    interpretationClass = 'capability-poor status-poor';
                } else {
                    interpretation = 'La media del proceso está fuera de especificaciones';
                    interpretationClass = 'capability-poor status-poor';
                }
            } else {
                document.getElementById('cp-value').textContent = '-';
                document.getElementById('cpk-value').textContent = '-';
                document.getElementById('yield-percent').textContent = '-';
                interpretation = 'Ingrese límites de especificación para calcular la capacidad del proceso';
                interpretationClass = 'capability-warning';
            }
            
            // Actualizar interpretación
            const interpretationDiv = document.getElementById('capability-interpretation');
            interpretationDiv.innerHTML = `
                <div class="capability-interpretation ${interpretationClass}">
                    <div class="interpretation-title">Interpretación:</div>
                    <div>${interpretation}</div>
                </div>
            `;
        }
        
        // Limpiar datos
        function clearData() {
            if (confirm('¿Está seguro de que desea eliminar todos los datos?')) {
                document.getElementById('data-body').innerHTML = '';
                sampleCounter = 1;
                addSample();
                
                // Reiniciar estadísticas
                document.getElementById('r-bar').textContent = '-';
                document.getElementById('process-mean').textContent = '-';
                document.getElementById('process-std').textContent = '-';
                document.getElementById('std-error').textContent = '-';
                
                document.getElementById('xbar-cl').textContent = '-';
                document.getElementById('xbar-ucl').textContent = '-';
                document.getElementById('xbar-lcl').textContent = '-';
                document.getElementById('xbar-usl').textContent = '-';
                document.getElementById('xbar-lsl').textContent = '-';
                
                document.getElementById('r-cl').textContent = '-';
                document.getElementById('r-ucl').textContent = '-';
                document.getElementById('r-lcl').textContent = '-';
                
                document.getElementById('cp-value').textContent = '-';
                document.getElementById('cpk-value').textContent = '-';
                document.getElementById('yield-percent').textContent = '-';
                
                document.getElementById('capability-interpretation').innerHTML = '';
                
                // Reiniciar estado de control
                document.getElementById('control-status').textContent = 'Estado del proceso: Sin datos suficientes para evaluación';
                document.getElementById('control-status').className = 'control-status';
                document.getElementById('out-of-control-count').textContent = '0';
                document.getElementById('out-of-spec-count').textContent = '0';
                document.getElementById('recommendations').textContent = 'Ingrese más datos para obtener recomendaciones';
                
                // Reiniciar gráficos
                if (xbarChart) {
                    xbarChart.data.labels = [];
                    xbarChart.data.datasets.forEach(dataset => {
                        dataset.data = [];
                    });
                    xbarChart.update();
                }
                
                if (rChart) {
                    rChart.data.labels = [];
                    rChart.data.datasets.forEach(dataset => {
                        dataset.data = [];
                    });
                    rChart.update();
                }
                
                // Actualizar resumen
                updateDashboardSummary();
            }
        }
        
        // Inicializar gráficos
        function initializeCharts() {
            const xbarCtx = document.getElementById('xbar-chart').getContext('2d');
            const rCtx = document.getElementById('r-chart').getContext('2d');
            
            // Configuración común para gráficos
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Día'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Valor'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            };
            
            // Gráfico X̄ con límites de especificación
            xbarChart = new Chart(xbarCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Media (X̄)',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1,
                            pointRadius: 4
                        },
                        {
                            label: 'Línea Central (CL)',
                            data: [],
                            borderColor: 'rgb(0, 0, 0)',
                            borderDash: [5, 5],
                            pointRadius: 0
                        },
                        {
                            label: 'Límite Superior de Control (UCL)',
                            data: [],
                            borderColor: 'rgb(220, 53, 69)',
                            borderDash: [5, 5],
                            pointRadius: 0
                        },
                        {
                            label: 'Límite Inferior de Control (LCL)',
                            data: [],
                            borderColor: 'rgb(220, 53, 69)',
                            borderDash: [5, 5],
                            pointRadius: 0
                        },
                        {
                            label: 'Límite Superior de Especificación (USL)',
                            data: [],
                            borderColor: 'rgb(255, 0, 0)',
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: 'Límite Inferior de Especificación (LSL)',
                            data: [],
                            borderColor: 'rgb(255, 0, 0)',
                            borderWidth: 2,
                            pointRadius: 0
                        }
                    ]
                },
                options: chartOptions
            });
            
            // Gráfico R
            rChart = new Chart(rCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Rango (R)',
                            data: [],
                            borderColor: 'rgb(255, 159, 64)',
                            backgroundColor: 'rgba(255, 159, 64, 0.1)',
                            tension: 0.1,
                            pointRadius: 4
                        },
                        {
                            label: 'Línea Central (CL)',
                            data: [],
                            borderColor: 'rgb(0, 0, 0)',
                            borderDash: [5, 5],
                            pointRadius: 0
                        },
                        {
                            label: 'Límite Superior de Control (UCL)',
                            data: [],
                            borderColor: 'rgb(220, 53, 69)',
                            borderDash: [5, 5],
                            pointRadius: 0
                        },
                        {
                            label: 'Límite Inferior de Control (LCL)',
                            data: [],
                            borderColor: 'rgb(220, 53, 69)',
                            borderDash: [5, 5],
                            pointRadius: 0
                        }
                    ]
                },
                options: chartOptions
            });
        }
        
        // Actualizar gráficos con datos
        function updateCharts(sampleNumbers, sampleMeans, sampleRanges, processMean, xbarUCL, xbarLCL, rBar, rUCL, rLCL, usl, lsl) {
            // Actualizar gráfico X̄
            xbarChart.data.labels = sampleNumbers;
            xbarChart.data.datasets[0].data = sampleMeans;
            xbarChart.data.datasets[1].data = Array(sampleNumbers.length).fill(processMean);
            xbarChart.data.datasets[2].data = Array(sampleNumbers.length).fill(xbarUCL);
            xbarChart.data.datasets[3].data = Array(sampleNumbers.length).fill(xbarLCL);
            
            // Actualizar límites de especificación si están definidos
            if (usl !== null) {
                xbarChart.data.datasets[4].data = Array(sampleNumbers.length).fill(usl);
            } else {
                xbarChart.data.datasets[4].data = [];
            }
            
            if (lsl !== null) {
                xbarChart.data.datasets[5].data = Array(sampleNumbers.length).fill(lsl);
            } else {
                xbarChart.data.datasets[5].data = [];
            }
            
            xbarChart.update();
            
            // Actualizar gráfico R
            rChart.data.labels = sampleNumbers;
            rChart.data.datasets[0].data = sampleRanges;
            rChart.data.datasets[1].data = Array(sampleNumbers.length).fill(rBar);
            rChart.data.datasets[2].data = Array(sampleNumbers.length).fill(rUCL);
            rChart.data.datasets[3].data = Array(sampleNumbers.length).fill(rLCL);
            rChart.update();
        }
        
        // Actualizar estado de especificaciones
        function updateSpecStatus() {
            const usl = document.getElementById('usl').value;
            const lsl = document.getElementById('lsl').value;
            const uslStatus = document.getElementById('usl-status');
            const lslStatus = document.getElementById('lsl-status');
            
            if (usl) {
                uslStatus.textContent = 'USL aplicado - Se mostrará en el gráfico';
                uslStatus.className = 'spec-status spec-applied';
            } else {
                uslStatus.textContent = 'USL no especificado';
                uslStatus.className = 'spec-status spec-missing';
            }
            
            if (lsl) {
                lslStatus.textContent = 'LSL aplicado - Se mostrará en el gráfico';
                lslStatus.className = 'spec-status spec-applied';
            } else {
                lslStatus.textContent = 'LSL no especificado';
                lslStatus.className = 'spec-status spec-missing';
            }
        }
        
        // Funciones para modales
        function showImportModal() {
            document.getElementById('import-modal').style.display = 'flex';
        }
        
        function hideImportModal() {
            document.getElementById('import-modal').style.display = 'none';
            document.getElementById('file-input').value = '';
            document.getElementById('file-info').textContent = 'No se ha seleccionado ningún archivo';
        }
        
        function updateFileInfo() {
            const fileInput = document.getElementById('file-input');
            const fileInfo = document.getElementById('file-info');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileInfo.textContent = `Archivo seleccionado: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            } else {
                fileInfo.textContent = 'No se ha seleccionado ningún archivo';
            }
        }
        
        function importDataFromFile() {
            alert('Función de importación sería implementada aquí');
            hideImportModal();
        }
        
        // Exportar a PDF como reporte ejecutivo
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const processName = document.getElementById('process-name').value || 'Proceso Sin Nombre';
            const now = new Date();
            
            // Título del reporte
            doc.setFontSize(20);
            doc.text('REPORTE EJECUTIVO - CARTA DE CONTROL X̄-R', 105, 20, { align: 'center' });
            
            // Información del proceso
            doc.setFontSize(12);
            doc.text(`Proceso: ${processName}`, 20, 40);
            doc.text(`Fecha de generación: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, 20, 50);
            doc.text(`Días analizados: ${document.getElementById('samples-count').textContent}`, 20, 60);
            
            // Estado del proceso
            doc.setFontSize(14);
            doc.text('RESUMEN EJECUTIVO', 20, 80);
            doc.setFontSize(12);
            doc.text(`Estado del proceso: ${document.getElementById('process-status-value').textContent}`, 20, 95);
            doc.text(`Capacidad del proceso (Cpk): ${document.getElementById('cpk-summary').textContent}`, 20, 105);
            doc.text(`Puntos fuera de control: ${document.getElementById('out-of-control-count').textContent}`, 20, 115);
            doc.text(`Puntos fuera de especificación: ${document.getElementById('out-of-spec-count').textContent}`, 20, 125);
            
            // Interpretación de capacidad
            const interpretationDiv = document.getElementById('capability-interpretation');
            if (interpretationDiv.textContent.trim() !== '') {
                doc.text('Interpretación de capacidad:', 20, 140);
                const interpretationText = interpretationDiv.textContent.replace('Interpretación:', '').trim();
                const splitText = doc.splitTextToSize(interpretationText, 170);
                doc.text(splitText, 20, 150);
            }
            
            // Recomendaciones
            doc.text('Recomendaciones:', 20, 170);
            const recommendationsText = document.getElementById('recommendations').textContent;
            const splitRecommendations = doc.splitTextToSize(recommendationsText, 170);
            doc.text(splitRecommendations, 20, 180);
            
            // Estadísticas del proceso
            doc.addPage();
            doc.setFontSize(16);
            doc.text('ESTADÍSTICAS DEL PROCESO', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            
            const stats = [
                `Rango promedio (R̄): ${document.getElementById('r-bar').textContent}`,
                `Media del proceso (μ̂): ${document.getElementById('process-mean').textContent}`,
                `Desviación estándar (σ̂): ${document.getElementById('process-std').textContent}`,
                `Error estándar (σX̄): ${document.getElementById('std-error').textContent}`
            ];
            
            stats.forEach((stat, index) => {
                doc.text(stat, 20, 40 + index * 10);
            });
            
            // Límites de control
            doc.text('Límites de Control para X̄:', 20, 85);
            doc.text(`Línea Central (CL): ${document.getElementById('xbar-cl').textContent}`, 30, 95);
            doc.text(`Límite Superior (UCL): ${document.getElementById('xbar-ucl').textContent}`, 30, 105);
            doc.text(`Límite Inferior (LCL): ${document.getElementById('xbar-lcl').textContent}`, 30, 115);
            
            // Límites de especificación
            doc.text('Límites de Especificación:', 20, 130);
            doc.text(`Límite Superior (USL): ${document.getElementById('xbar-usl').textContent}`, 30, 140);
            doc.text(`Límite Inferior (LSL): ${document.getElementById('xbar-lsl').textContent}`, 30, 150);
            
            doc.text('Límites de Control para R:', 20, 165);
            doc.text(`Línea Central (CL): ${document.getElementById('r-cl').textContent}`, 30, 175);
            doc.text(`Límite Superior (UCL): ${document.getElementById('r-ucl').textContent}`, 30, 185);
            doc.text(`Límite Inferior (LCL): ${document.getElementById('r-lcl').textContent}`, 30, 195);
            
            // Capacidad del proceso
            if (document.getElementById('cp-value').textContent !== '-') {
                doc.text('Capacidad del Proceso:', 20, 210);
                doc.text(`Cₚ: ${document.getElementById('cp-value').textContent}`, 30, 220);
                doc.text(`Cₚₖ: ${document.getElementById('cpk-value').textContent}`, 30, 230);
                doc.text(`Rendimiento: ${document.getElementById('yield-percent').textContent}%`, 30, 240);
            }
            
            // Capturar y agregar gráficos al PDF
            const charts = document.querySelectorAll('.chart-container canvas');
            
            Promise.all(Array.from(charts).map((chart, index) => {
                return html2canvas(chart).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Agregar imagen al PDF
                    if (index === 0) {
                        doc.addPage();
                        doc.setFontSize(16);
                        doc.text('CARTA DE CONTROL X̄ (MEDIA) CON LÍMITES DE ESPECIFICACIÓN', 105, 20, { align: 'center' });
                        doc.addImage(imgData, 'PNG', 20, 30, 170, 100);
                    } else {
                        doc.addPage();
                        doc.setFontSize(16);
                        doc.text('CARTA DE CONTROL R (RANGO)', 105, 20, { align: 'center' });
                        doc.addImage(imgData, 'PNG', 20, 30, 170, 100);
                    }
                });
            })).then(() => {
                // Guardar PDF
                doc.save(`Reporte_Ejecutivo_${processName.replace(/\s+/g, '_')}_${now.getTime()}.pdf`);
            }).catch(error => {
                console.error('Error al generar PDF:', error);
                alert('Error al generar el PDF. Los gráficos podrían no estar disponibles.');
                doc.save(`Reporte_Ejecutivo_${processName.replace(/\s+/g, '_')}_${now.getTime()}.pdf`);
            });
        }
        
        // Mostrar modal de correo
        function showEmailModal() {
            document.getElementById('email-modal').style.display = 'flex';
        }
        
        // Ocultar modal de correo
        function hideEmailModal() {
            document.getElementById('email-modal').style.display = 'none';
        }
        
        // Enviar correo
        function sendEmail() {
            const to = document.getElementById('email-to').value;
            const subject = document.getElementById('email-subject').value;
            const message = document.getElementById('email-message').value;
            
            if (!to) {
                alert('Por favor, ingrese un destinatario');
                return;
            }
            
            // Crear contenido del correo
            const processName = document.getElementById('process-name').value || 'Proceso Sin Nombre';
            const now = new Date();
            
            let emailBody = `
                <h2>Reporte Ejecutivo - Carta de Control X̄-R</h2>
                <p><strong>Proceso:</strong> ${processName}</p>
                <p><strong>Fecha de generación:</strong> ${now.toLocaleDateString()} ${now.toLocaleTimeString()}</p>
                <hr>
                <h3>Resumen Ejecutivo</h3>
                <ul>
                    <li>Estado del proceso: ${document.getElementById('process-status-value').textContent}</li>
                    <li>Capacidad (Cpk): ${document.getElementById('cpk-summary').textContent}</li>
                    <li>Días analizados: ${document.getElementById('samples-count').textContent}</li>
                    <li>Puntos fuera de control: ${document.getElementById('out-of-control-count').textContent}</li>
                    <li>Puntos fuera de especificación: ${document.getElementById('out-of-spec-count').textContent}</li>
                </ul>
                <h3>Interpretación</h3>
                <p>${document.getElementById('capability-interpretation').textContent.replace('Interpretación:', '').trim()}</p>
                <h3>Recomendaciones</h3>
                <p>${document.getElementById('recommendations').textContent}</p>
            `;
            
            if (message) {
                emailBody += `<p><strong>Mensaje adicional:</strong> ${message}</p>`;
            }
            
            emailBody += `<p><em>Este reporte fue generado automáticamente por el sistema de Control de Calidad.</em></p>`;
            
            // Crear enlace de correo
            const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            // Abrir cliente de correo
            window.location.href = mailtoLink;
            
            hideEmailModal();
        }
    </script>
</body>
</html>